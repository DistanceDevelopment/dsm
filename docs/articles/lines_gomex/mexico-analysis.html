<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Example `dsm` analysis: pantropical dolphins in the Gulf of Mexico • dsm</title>
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../deps/search-1.0.0/fuse.min.js"></script><script src="../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Example `dsm` analysis: pantropical dolphins in the Gulf of Mexico">
<meta name="description" content="Example spatial analysis of pantropical spotted dolphins.
">
<meta property="og:description" content="Example spatial analysis of pantropical spotted dolphins.
">
<script type="text/javascript"> (function(c,l,a,r,i,t,y){ c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)}; t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i; y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);})(window, document, "clarity", "script","maw5mo10ad");</script><!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-2BP80F76X2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-2BP80F76X2');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../../index.html">dsm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.3.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../../articles/data_format/dsm-data-formatting.html">`dsm` data formatting example</a></li>
    <li><a class="dropdown-item" href="../../articles/lines_gomex/mexico-analysis.html">Example `dsm` analysis: pantropical dolphins in the Gulf of Mexico</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/DistanceDevelopment/dsm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Example `dsm` analysis: pantropical dolphins in the Gulf of Mexico</h1>
                        <h4 data-toc-skip class="author">David L Miller</h4>
            <address class="author_afil">
      CREEM, Univ of St Andrews<br><h4 data-toc-skip class="date">September 2025</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/DistanceDevelopment/dsm/blob/HEAD/vignettes/lines_gomex/mexico-analysis.Rmd" class="external-link"><code>vignettes/lines_gomex/mexico-analysis.Rmd</code></a></small>
      <div class="d-none name"><code>mexico-analysis.Rmd</code></div>
    </address>
</div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The analysis is based on a dataset of observations of pantropical dolphins in the Gulf of Mexico (shipped with Distance 6.0 and later). For convenience the data are bundled in an <code>R</code>-friendly format, although all of the code necessary for creating the data from the Distance project files is available <a href="http://github.com/dill/mexico-data" class="external-link">on github</a>. The OBIS-SEAMAP page for the data may be found at the <a href="http://seamap.env.duke.edu/dataset/25" class="external-link">SEFSC GoMex Oceanic 1996</a> survey page.</p>
<p>The intention here is to highlight the features of the <code>dsm</code> package, rather than perform a full analysis of the data. For that reason, some important steps are not fully explored. Some familiarity with density surface modelling <span class="citation">(Miller, Burt, Rexstad, &amp; Thomas, 2013)</span> <span class="citation">(Hedley &amp; Buckland, 2004)</span> is assumed.</p>
</div>
<div class="section level2">
<h2 id="preamble">Preamble<a class="anchor" aria-label="anchor" href="#preamble"></a>
</h2>
<p>Before we start, we load the <code>dsm</code> package (and its dependencies) and set some options:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DistanceDevelopment/dsm" class="external-link">dsm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plotting options</span></span>
<span><span class="va">gg.opts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid.major<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                 panel.grid.minor<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                 panel.background<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>In order to run this vignette, you’ll need to install a few R packages. This can be done via the following call to <code>install.packages</code>:</p>
<pre><code><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dsm"</span>, <span class="st">"Distance"</span>, <span class="st">"knitr"</span>, <span class="st">"distill"</span>, <span class="st">"ggplot2"</span>, <span class="st">"rgdal"</span>,</span>
<span>                   <span class="st">"maptools"</span>, <span class="st">"plyr"</span>, <span class="st">"tweedie"</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="the-data">The data<a class="anchor" aria-label="anchor" href="#the-data"></a>
</h2>
<p>Most of the data we need is included in the <code>dsm</code> package, but two additional objects needed for plotting are required and can be downloaded <a href="https://examples.distancesampling.org/dsm-line-dolphins/mexdolphins-extra.rda" class="external-link">here</a> and should be put into the same directory as this file. The data can then be loaded into R using the following code:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"mexdolphins-extra.rda"</span><span class="op">)</span></span></code></pre></div>
<p>This should add the objects <code>survey.area</code> and <code>pred.polys</code> to your environment.</p>
<div class="section level3">
<h3 id="observation-and-segment-data">Observation and segment data<a class="anchor" aria-label="anchor" href="#observation-and-segment-data"></a>
</h3>
<p>All of the data for this analysis has been nicely pre-formatted and is shipped with <code>dsm</code>. Loading that data, we can see that we have four <code>data.frame</code>s, the first few lines of each are shown:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">mexdolphins</span><span class="op">)</span></span></code></pre></div>
<p><code>segdata</code> holds the segment data: the transects have already been “chopped” into segments.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">segdata</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   longitude latitude        x        y Effort Transect.Label Sample.Label depth</span></span>
<span><span class="co">## 1 -86.92712 29.94378 836105.9 -1011416  13800       19960417   19960417-1 135.0</span></span>
<span><span class="co">## 2 -86.83176 29.84030 846012.9 -1021407  14000       19960417   19960417-2 147.7</span></span>
<span><span class="co">## 3 -86.74445 29.75279 855022.6 -1029785  14000       19960417   19960417-3 152.1</span></span>
<span><span class="co">## 4 -86.65230 29.65522 864610.3 -1039168  13900       19960417   19960417-4 163.8</span></span>
<span><span class="co">## 5 -86.56648 29.56088 873598.1 -1048266  13800       19960417   19960417-5 179.7</span></span>
<span><span class="co">## 6 -86.49290 29.49000 881203.7 -1055004  13800       19960417   19960417-6 188.5</span></span></code></pre>
<p><code>distdata</code> holds the distance sampling data that will be used to fit the detection function.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">distdata</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     object size  distance Effort detected beaufort latitude longitude</span></span>
<span><span class="co">## 45      45   21 3296.6363  36300        1        4 27.72872 -86.00159</span></span>
<span><span class="co">## 61      61  150  929.1937  17800        1        4 25.99896 -87.62712</span></span>
<span><span class="co">## 63      63  125 6051.0009  21000        1        2 26.00693 -87.94881</span></span>
<span><span class="co">## 85      85   75 5499.6971  21800        1        1 27.50344 -90.44891</span></span>
<span><span class="co">## 114    114   50 7258.9837  13400        1        3 27.40568 -94.99483</span></span>
<span><span class="co">## 120    120   45 1454.7962  20900        1        5 26.01765 -95.97449</span></span>
<span><span class="co">##              x        y</span></span>
<span><span class="co">## 45  948000.065 -1236192</span></span>
<span><span class="co">## 61  812161.653 -1436899</span></span>
<span><span class="co">## 63  780969.520 -1438985</span></span>
<span><span class="co">## 85  528656.807 -1297833</span></span>
<span><span class="co">## 114  95910.149 -1324562</span></span>
<span><span class="co">## 120   2477.665 -1473909</span></span></code></pre>
<p><code>obsdata</code> links the distance data to the segments.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">obsdata</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     object Sample.Label size  distance Effort</span></span>
<span><span class="co">## 45      45   19960421-9   21 3296.6363  36300</span></span>
<span><span class="co">## 61      61   19960423-7  150  929.1937  17800</span></span>
<span><span class="co">## 63      63   19960423-9  125 6051.0009  21000</span></span>
<span><span class="co">## 85      85   19960427-1   75 5499.6971  21800</span></span>
<span><span class="co">## 114    114   19960430-8   50 7258.9837  13400</span></span>
<span><span class="co">## 120    120   19960501-5   45 1454.7962  20900</span></span></code></pre>
<p><code>preddata</code> holds the prediction grid (which includes all the necessary covariates).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">preddata</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   latitude longitude        x          y depth      area</span></span>
<span><span class="co">## 1 30.08333 -87.58333 774402.9 -1002759.1    35 271236913</span></span>
<span><span class="co">## 2 30.08333 -87.41667 789688.6 -1001264.5    30 271236913</span></span>
<span><span class="co">## 3 30.08333 -87.25000 804971.3  -999740.6    27 271236913</span></span>
<span><span class="co">## 4 30.08333 -87.08333 820251.1  -998187.5    22 271236913</span></span>
<span><span class="co">## 5 30.08333 -86.91667 835528.0  -996605.2    46 271236913</span></span>
<span><span class="co">## 6 29.91667 -87.75000 760783.1 -1021810.3    14 271236913</span></span></code></pre>
<p>Typically (i.e. for other datasets) it will be necessary divide the transects into segments, and allocate observations to the correct segments using a GIS or other similar package<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;These operations can be performed in R using the &lt;code&gt;sp&lt;/code&gt; and &lt;code&gt;rgeos&lt;/code&gt; packages. It may, however, be easier to perform these operations in GIS such as ArcGIS – in which case the MGET Toolbox may be useful.&lt;/p&gt;"><sup>1</sup></a>, before starting an analysis using <code>dsm</code>.</p>
</div>
<div class="section level3">
<h3 id="shapefiles-and-converting-units">Shapefiles and converting units<a class="anchor" aria-label="anchor" href="#shapefiles-and-converting-units"></a>
</h3>
<p>Often data in a spatial analysis comes from many different sources. It is important to ensure that the measurements to be used in the analysis are in compatible units, otherwise the resulting estimates will be incorrect or hard to interpret. Having all of our measurements in SI units from the outset removes the need for conversion later, making life much easier.</p>
<p>The data are already in the appropriate units (Northings and Eastings: kilometres from a centroid, projected using the <a href="https://en.wikipedia.org/wiki/Lambert_conformal_conic_projection" class="external-link">North American Lambert Conformal Conic projection</a>).</p>
<p>There is extensive literature about when particular projections of latitude and longitude are appropriate and we highly recommend the reader review this for their particular study area; <span class="citation">(Bivand, Pebesma, &amp; Gómez-Rubio, 2008)</span> is a good starting point. The other data frames have already had their measurements appropriately converted. By convention the directions are named <code>x</code> and <code>y</code>.</p>
<p>Using latitude and longitude when performing spatial smoothing can be problematic when certain smoother bases are used. In particular when bivariate isotropic bases are used the non-isotropic nature of latitude and longitude is inconsistent (moving one degree in one direction is not the same as moving one degree in the other).</p>
<p>We give an example of projecting the polygon that defines the survey area (which as simply been read into R using <code>readShapeSpatial</code> from a shapefile produced by GIS).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://had.co.nz/plyr" class="external-link">plyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># tell R that the survey.area object is currently in lat/long</span></span>
<span><span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://edzer.github.io/sp/reference/is.projected.html" class="external-link">proj4string</a></span><span class="op">(</span><span class="va">survey.area</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://edzer.github.io/sp/reference/CRS-class.html" class="external-link">CRS</a></span><span class="op">(</span><span class="st">"+proj=longlat +datum=WGS84"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">predsf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">pred.polys</span><span class="op">)</span></span>
<span></span>
<span><span class="va">area.sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">survey.area</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">area.sf</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"WGS84"</span></span>
<span><span class="va">area.sf.proj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">area.sf</span>, crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">predsf</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert preddata to a spatial object</span></span>
<span><span class="va">preddata_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">preddata</span>, coords<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">preddata_sf</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">area.sf.proj</span><span class="op">)</span></span>
<span><span class="co"># Perform the intersection</span></span>
<span><span class="va">preddata_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">preddata_sf</span>, <span class="va">area.sf.proj</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: attribute variables are assumed to be spatially constant throughout</span></span>
<span><span class="co">## all geometries</span></span></code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coords_preddata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">preddata_sf</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">preddata_sf</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">coords_preddata</span><span class="op">$</span><span class="va">X</span></span>
<span><span class="va">preddata_sf</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">coords_preddata</span><span class="op">$</span><span class="va">Y</span> </span></code></pre></div>
<p>Next bit of code works with the <code>study.area</code> outline, massaging it for use with soap film smoother. If you will not be using soap film smoothers, the code is extraneous.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># proj 4 string</span></span>
<span><span class="co"># using http://spatialreference.org/ref/esri/north-america-lambert-conformal-conic/</span></span>
<span><span class="va">lcc_proj4</span> <span class="op">&lt;-</span> <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://edzer.github.io/sp/reference/CRS-class.html" class="external-link">CRS</a></span><span class="op">(</span><span class="st">"+proj=lcc +lat_1=20 +lat_2=60 +lat_0=40 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs "</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># project using LCC</span></span>
<span><span class="va">survey.area</span> <span class="op">&lt;-</span> <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://edzer.github.io/sp/reference/spTransform.html" class="external-link">spTransform</a></span><span class="op">(</span><span class="va">survey.area</span>, CRSobj<span class="op">=</span><span class="va">lcc_proj4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simplify the object</span></span>
<span><span class="va">survey.area</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">survey.area</span><span class="op">@</span><span class="va">polygons</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">Polygons</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">coords</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">survey.area</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span></span></code></pre></div>
<p>The below code generates this plot, which shows the survey area with the transect lines overlaid (using data from <code>segdata</code>).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">segdata_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">segdata</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">segdata_sf</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">area.sf.proj</span><span class="op">)</span></span>
<span><span class="co"># study area outline and segment centres</span></span>
<span><span class="va">plot_segments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">area.sf.proj</span>, fill<span class="op">=</span><span class="st">"lightblue"</span>, color <span class="op">=</span> <span class="st">"blue"</span>, linewidth<span class="op">=</span><span class="fl">.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">segdata_sf</span>, fill<span class="op">=</span><span class="cn">NA</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"1996 SE Fisheries Science Center Gulf of Mexico cruise"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Points are segment centres"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"magma"</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="va">plot_segments</span></span></code></pre></div>
<p><img src="mexico-analysis_files/figure-html/areawithtransects-1.png"><!-- --></p>
<p>Also note that since we have projected our prediction grid, the “squares” do not look quite like squares. So for plotting we will use the polygons that we have saved, these polygons (stored in <code>pred.polys</code>) are read from a shapefile created in GIS, the object itself is of class <code>SpatialPolygons</code> from the <code>sp</code> package. It needs project for proper plotting using functions in the <code>sf</code> package. predsf &lt;- st_as_sf(pred.polys)</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predsf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">pred.polys</span><span class="op">)</span></span>
<span><span class="co"># plot as projected</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">predsf</span><span class="op">)</span>, axes<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="mexico-analysis_files/figure-html/projection-compare-1.png"><!-- --></p>
<p>Tips on plotting polygons are available from <a href="https://ggplot2.tidyverse.org/reference/ggsf.html?q=geom_sf#null" class="external-link">the <code>ggplot2</code> pkg_down</a>.</p>
</div>
</div>
<div class="section level2">
<h2 id="exploratory-data-analysis">Exploratory data analysis<a class="anchor" aria-label="anchor" href="#exploratory-data-analysis"></a>
</h2>
<div class="section level3">
<h3 id="distance-data">Distance data<a class="anchor" aria-label="anchor" href="#distance-data"></a>
</h3>
<p>The top panels of the EDA plots below show histograms of observed distances and cluster size, while the bottom panels show the relationship between observed distance and observed cluster size, and the relationship between observed distance and Beaufort sea state. The plots show that there is some relationship between cluster size and observed distance (fewer smaller clusters seem to be seen at larger distances).</p>
<p>The following code generates the EDA plots:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># histograms</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">distdata</span><span class="op">$</span><span class="va">distance</span>,main<span class="op">=</span><span class="st">""</span>,xlab<span class="op">=</span><span class="st">"Distance (m)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">distdata</span><span class="op">$</span><span class="va">size</span>,main<span class="op">=</span><span class="st">""</span>,xlab<span class="op">=</span><span class="st">"Cluster size"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plots of distance vs. cluster size</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">distdata</span><span class="op">$</span><span class="va">distance</span>, <span class="va">distdata</span><span class="op">$</span><span class="va">size</span>, main<span class="op">=</span><span class="st">""</span>, xlab<span class="op">=</span><span class="st">"Distance (m)"</span>,</span>
<span>     ylab<span class="op">=</span><span class="st">"Group size"</span>, pch<span class="op">=</span><span class="fl">19</span>, cex<span class="op">=</span><span class="fl">0.5</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html" class="external-link">gray</a></span><span class="op">(</span><span class="fl">0.7</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># lm fit</span></span>
<span><span class="va">l.dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>distance<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">8000</span>,len<span class="op">=</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">size</span><span class="op">~</span><span class="va">distance</span>, data<span class="op">=</span><span class="va">distdata</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">l.dat</span><span class="op">$</span><span class="va">distance</span>, <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">lo</span>,<span class="va">l.dat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">distdata</span><span class="op">$</span><span class="va">distance</span>,<span class="va">distdata</span><span class="op">$</span><span class="va">beaufort</span>, main<span class="op">=</span><span class="st">""</span>, xlab<span class="op">=</span><span class="st">"Distance (m)"</span>,</span>
<span>     ylab<span class="op">=</span><span class="st">"Beaufort sea state"</span>, pch<span class="op">=</span><span class="fl">19</span>, cex<span class="op">=</span><span class="fl">0.5</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html" class="external-link">gray</a></span><span class="op">(</span><span class="fl">0.7</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="mexico-analysis_files/figure-html/EDA-plots-1.png"><!-- --></p>
<p>Top row, left to right: histograms of distance and cluster size; bottom row: plot of distance against cluster size and plot of distances against Beaufort sea state.</p>
</div>
<div class="section level3">
<h3 id="spatial-data">Spatial data<a class="anchor" aria-label="anchor" href="#spatial-data"></a>
</h3>
<p>Looking separately at the spatial data without thinking about the distances, we can plot the observed group sizes in space (point size is proportional to the group size for each observation). Circle size indicates the size of the group in the observation. There are rather large areas with no observations, which might cause our variance estimates for abundance to be rather large. We also see the depth data which we will use depth later as an explanatory covariate in our spatial model.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prediction_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html" class="external-link">st_make_grid</a></span><span class="op">(</span><span class="va">area.sf.proj</span>, cellsize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9000</span>,<span class="fl">9000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">prediction_grid_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">st_sf</a></span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">prediction_grid</span><span class="op">)</span></span>
<span><span class="va">cropped_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_join</a></span><span class="op">(</span><span class="va">prediction_grid_sf</span>, <span class="va">preddata_sf</span>, join <span class="op">=</span> <span class="va">st_nearest_feature</span><span class="op">)</span></span>
<span><span class="va">cropped_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">cropped_grid</span>, <span class="va">area.sf.proj</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: attribute variables are assumed to be spatially constant throughout</span></span>
<span><span class="co">## all geometries</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">depth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">cropped_grid</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">depth</span><span class="op">)</span>, color<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Spotted dolphins, Gulf of Mexico"</span>,</span>
<span>              subtitle <span class="op">=</span> <span class="st">"Depth in meters, size of detected dolphin groups"</span><span class="op">)</span> <span class="op">+</span></span>
<span>         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Longitude"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Latitude"</span><span class="op">)</span> <span class="op">+</span></span>
<span>         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, size<span class="op">=</span><span class="va">size</span><span class="op">)</span>, data<span class="op">=</span><span class="va">distdata</span>, colour<span class="op">=</span><span class="st">"red"</span>,alpha<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"viridis"</span>, direction <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">depth</span></span></code></pre></div>
<p><img src="mexico-analysis_files/figure-html/spatialEDA-1.png"><!-- --></p>
</div>
</div>
<div class="section level2">
<h2 id="estimating-the-detection-function">Estimating the detection function<a class="anchor" aria-label="anchor" href="#estimating-the-detection-function"></a>
</h2>
<p>We use the <code>ds</code> function in the package <code>Distance</code> to fit the detection function. (The <code>Distance</code> package is intended to make standard distance sampling in <code>R</code> relatively straightforward. For a more flexible but more complex alternative, see the function <code>ddf</code> in the <code>mrds</code> library.)</p>
<p>First, loading the <code>Distance</code> library:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DistanceDevelopment/Distance/" class="external-link">Distance</a></span><span class="op">)</span></span></code></pre></div>
<p>We can then fit a detection function with hazard-rate key with no adjustment terms:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">detfc.hr.null</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Distance/man/ds.html" class="external-link">ds</a></span><span class="op">(</span><span class="va">distdata</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">distdata</span><span class="op">$</span><span class="va">distance</span><span class="op">)</span>, key<span class="op">=</span><span class="st">"hr"</span>, adjustment<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in ddf.ds(dsmodel = dsmodel, data = data, meta.data = meta.data, :</span></span>
<span><span class="co">## Estimated hazard-rate scale parameter close to 0 (on log scale). Possible</span></span>
<span><span class="co">## problem in data (e.g., spike near zero distance).</span></span></code></pre>
<pre><code><span><span class="co">## Warning in ds(distdata, max(distdata$distance), key = "hr", adjustment = NULL):</span></span>
<span><span class="co">## Estimated hazard-rate scale parameter close to 0 (on log scale). Possible</span></span>
<span><span class="co">## problem in data (e.g., spike near zero distance).</span></span></code></pre>
<p>Calling <code>summary</code> gives us information about parameter estimates, probability of detection, AIC, etc:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">detfc.hr.null</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Summary for distance analysis </span></span>
<span><span class="co">## Number of observations :  47 </span></span>
<span><span class="co">## Distance range         :  0  -  7847.467 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Model       : Hazard-rate key function </span></span>
<span><span class="co">## AIC         :  841.2528 </span></span>
<span><span class="co">## Optimisation:  mrds (nlminb) </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Detection function parameters</span></span>
<span><span class="co">## Scale coefficient(s):  </span></span>
<span><span class="co">##             estimate        se</span></span>
<span><span class="co">## (Intercept)  7.98244 0.9533779</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Shape coefficient(s):  </span></span>
<span><span class="co">##             estimate        se</span></span>
<span><span class="co">## (Intercept)        0 0.7833406</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##                       Estimate         SE        CV</span></span>
<span><span class="co">## Average p            0.5912252  0.2224714 0.3762887</span></span>
<span><span class="co">## N in covered region 79.4959326 30.8184416 0.3876732</span></span></code></pre>
<p>The following code generates a plot of the fitted detection function (left) and quantile-quantile plot (right):</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">detfc.hr.null</span>, showpoints<span class="op">=</span><span class="cn">FALSE</span>, pl.den<span class="op">=</span><span class="fl">0</span>, lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Distance/man/gof_ds.html" class="external-link">gof_ds</a></span><span class="op">(</span><span class="va">detfc.hr.null</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Goodness of fit results for ddf object</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Distance sampling Cramer-von Mises test (unweighted)</span></span>
<span><span class="co">## Test statistic = 0.0972004 p-value = 0.598774</span></span></code></pre>
<p><img src="mexico-analysis_files/figure-html/hr-detfct-1.png"><img src="mexico-analysis_files/figure-html/hr-detfct-2.png"></p>
<p>The quantile-quantile plot show relatively good goodness of fit for the hazard-rate detection function.</p>
<div class="section level3">
<h3 id="adding-covariates-to-the-detection-function">Adding covariates to the detection function<a class="anchor" aria-label="anchor" href="#adding-covariates-to-the-detection-function"></a>
</h3>
<p>It is common to include covariates in the detection function (so-called Multiple Covariate Distance Sampling or MCDS). In this dataset there are two covariates that were collected on each individual: Beaufort sea state and size. For brevity we fit only a hazard-rate detection functions with the sea state included as a factor covariate as follows:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">detfc.hr.beau</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/Distance/man/ds.html" class="external-link">ds</a></span><span class="op">(</span><span class="va">distdata</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">distdata</span><span class="op">$</span><span class="va">distance</span><span class="op">)</span>, formula<span class="op">=</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">beaufort</span><span class="op">)</span>,</span>
<span>                  key<span class="op">=</span><span class="st">"hr"</span>, adjustment<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p>Again looking at the <code>summary</code>,</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">detfc.hr.beau</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Summary for distance analysis </span></span>
<span><span class="co">## Number of observations :  47 </span></span>
<span><span class="co">## Distance range         :  0  -  7847.467 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Model       : Hazard-rate key function </span></span>
<span><span class="co">## AIC         :  843.7117 </span></span>
<span><span class="co">## Optimisation:  mrds (nlminb) </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Detection function parameters</span></span>
<span><span class="co">## Scale coefficient(s):  </span></span>
<span><span class="co">##                        estimate        se</span></span>
<span><span class="co">## (Intercept)           7.6631807  1.077115</span></span>
<span><span class="co">## as.factor(beaufort)2  2.2796347 17.294287</span></span>
<span><span class="co">## as.factor(beaufort)3  0.2860623  1.019185</span></span>
<span><span class="co">## as.factor(beaufort)4  0.0717478  1.223465</span></span>
<span><span class="co">## as.factor(beaufort)5 -0.3639848  1.537672</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Shape coefficient(s):  </span></span>
<span><span class="co">##              estimate        se</span></span>
<span><span class="co">## (Intercept) 0.3004326 0.5179983</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##                       Estimate         SE        CV</span></span>
<span><span class="co">## Average p            0.5421265  0.1750696 0.3229313</span></span>
<span><span class="co">## N in covered region 86.6956354 29.4151901 0.3392926</span></span></code></pre>
<p>Here the detection function with covariates does not give a lower AIC than the model without covariates (843.71 vs. 841.25 for the hazard-rate model without covariates). Looking back to the bottom-right panel of the EDA plots, we can see there is not a discernible pattern in the plot of Beaufort vs distance.</p>
<p>For brevity, detection function model selection has been omitted here. In practise we would fit many different forms for the detection function (and select a model based on goodness of fit testing and AIC).</p>
</div>
</div>
<div class="section level2">
<h2 id="fitting-a-dsm">Fitting a DSM<a class="anchor" aria-label="anchor" href="#fitting-a-dsm"></a>
</h2>
<p>Before fitting a <code>dsm</code> model, the data must be segmented; this consists of chopping up the transects and attributing counts to each of the segments. As mentioned above, these data have already been segmented.</p>
<div class="section level3">
<h3 id="a-simple-model">A simple model<a class="anchor" aria-label="anchor" href="#a-simple-model"></a>
</h3>
<p>We begin with a very simple model. We assume that the number of individuals in each segment are quasi-Poisson distributed and that they are a smooth function of their spatial coordinates (note that the formula is exactly as one would specify to <code>gam</code> in <code>mgcv</code>). By setting <code>group=TRUE</code>, the abundance of clusters/groups rather than individuals can be estimated (though we ignore this here). Note we set <code>method="REML"</code> to ensure that smooth terms are estimated reliably.</p>
<p>Running the model:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dsm.xy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/dsm.html">dsm</a></span><span class="op">(</span><span class="va">count</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span>, <span class="va">detfc.hr.null</span>, <span class="va">segdata</span>, <span class="va">obsdata</span>, method<span class="op">=</span><span class="st">"REML"</span><span class="op">)</span></span></code></pre></div>
<p>We can then obtain a summary of the fitted model:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">dsm.xy</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Family: quasipoisson </span></span>
<span><span class="co">## Link function: log </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Formula:</span></span>
<span><span class="co">## count ~ s(x, y) + offset(off.set)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parametric coefficients:</span></span>
<span><span class="co">##             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">## (Intercept)   -18.20       0.53  -34.34   &lt;2e-16 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Approximate significance of smooth terms:</span></span>
<span><span class="co">##         edf Ref.df     F  p-value    </span></span>
<span><span class="co">## s(x,y) 24.8  27.49 2.354 0.000733 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## R-sq.(adj) =  0.121   Deviance explained = 43.4%</span></span>
<span><span class="co">## -REML = 936.04  Scale est. = 94.367    n = 387</span></span></code></pre>
<p>The exact interpretation of the model summary results can be found in <span class="citation">(S. N. Wood, 2017)</span>; here we can see various information about the smooth components fitted and general model statistics.</p>
<p>We can use the deviance explained to compare between models<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Note though that the adjusted &lt;span class="math inline"&gt;\(R^2\)&lt;/span&gt; for the model is defined as the proportion of variance explained but the “original” variance used for comparison doesn’t include the offset (the area (or effective of the segments). It is therefore not recommended for one to directly interpret the &lt;span class="math inline"&gt;\(R^2\)&lt;/span&gt; value (see the &lt;code&gt;summary.gam&lt;/code&gt; manual page for further details).&lt;/p&gt;'><sup>2</sup></a>.</p>
<p>We can also get a rough idea of what the smooth of space looks like using <code>vis.gam</code> (white/yellow indicates high values, red low indicates low values):</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/vis.gam.html" class="external-link">vis.gam</a></span><span class="op">(</span><span class="va">dsm.xy</span>, plot.type<span class="op">=</span><span class="st">"contour"</span>, view<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span>, asp<span class="op">=</span><span class="fl">1</span>, type<span class="op">=</span><span class="st">"response"</span>, contour.col<span class="op">=</span><span class="st">"black"</span>, n.grid<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p><img src="mexico-analysis_files/figure-html/visgam1-1.png"><!-- --></p>
<p>The <code>type="response"</code> argument ensures that the plot is on the scale of abundance but the values are relative (as the offsets are set to be their median values). This means that the plot is useful to get an idea of the general shape of the smooth but cannot be interpreted directly.</p>
</div>
<div class="section level3">
<h3 id="adding-another-environmental-covariate-to-the-spatial-model">Adding another environmental covariate to the spatial model<a class="anchor" aria-label="anchor" href="#adding-another-environmental-covariate-to-the-spatial-model"></a>
</h3>
<p>The data set also contains a <code>depth</code> covariate (which we plotted above). We can include in the model very simply:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dsm.xy.depth</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/dsm.html">dsm</a></span><span class="op">(</span><span class="va">count</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>,k<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">depth</span>,k<span class="op">=</span><span class="fl">20</span><span class="op">)</span>, <span class="va">detfc.hr.null</span>, <span class="va">segdata</span>, <span class="va">obsdata</span>, method<span class="op">=</span><span class="st">"REML"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">dsm.xy.depth</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Family: quasipoisson </span></span>
<span><span class="co">## Link function: log </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Formula:</span></span>
<span><span class="co">## count ~ s(x, y, k = 10) + s(depth, k = 20) + offset(off.set)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parametric coefficients:</span></span>
<span><span class="co">##             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">## (Intercept)  -18.740      1.236  -15.16   &lt;2e-16 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Approximate significance of smooth terms:</span></span>
<span><span class="co">##            edf Ref.df     F p-value  </span></span>
<span><span class="co">## s(x,y)   6.062  7.371 0.923  0.5038  </span></span>
<span><span class="co">## s(depth) 9.443 11.466 1.585  0.0824 .</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## R-sq.(adj) =  0.0909   Deviance explained = 34.3%</span></span>
<span><span class="co">## -REML = 939.52  Scale est. = 124.9     n = 387</span></span></code></pre>
<p>Here we see a drop in deviance explained, so perhaps this model is not as useful as the first. We discuss setting the <code>k</code> parameter in <a href="#model-checking">Model checking</a>, below.</p>
<p>Setting <code>select=TRUE</code> here (as an argument to <code>gam</code>) would impose extra shrinkage terms on each smooth in the model (allowing smooth terms to be removed from the model during fitting; see <code><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">?gam</a></code> for more information). This is not particularly useful here, so we do not include it. However when there are many environmental predictors is in the model this can be a good way (along with looking at <span class="math inline">\(p\)</span>-values) to perform term selection.</p>
<p>Simply calling <code>plot</code> on the model object allows us to look at the relationship between depth and the linear predictor:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dsm.xy.depth</span>, select<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="mexico-analysis_files/figure-html/dsm-xy-depth-depth-1.png"><!-- --></p>
<p>Omitting the argument <code>select</code> in the call to <code>plot</code> will plot each of the smooth terms, one at a time.</p>
</div>
<div class="section level3">
<h3 id="spatial-models-when-there-are-covariates-in-the-detection-function">Spatial models when there are covariates in the detection function<a class="anchor" aria-label="anchor" href="#spatial-models-when-there-are-covariates-in-the-detection-function"></a>
</h3>
<p>The code to fit the DSM when there are covariates in the detection function is similar to the other models, above. However since the detection function has observation-level covariates, we must estimate the abundance per segment using a Horvitz-Thompson-like estimator before modelling, so we change the response to be <code>abundance.est</code>:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dsm.est.xy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/dsm.html">dsm</a></span><span class="op">(</span><span class="va">abundance.est</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span>, <span class="va">detfc.hr.beau</span>, <span class="va">segdata</span>, <span class="va">obsdata</span>, method<span class="op">=</span><span class="st">"REML"</span><span class="op">)</span></span></code></pre></div>
<p>As we can see, the <code>summary</code> results are rather similar:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">dsm.est.xy</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Family: quasipoisson </span></span>
<span><span class="co">## Link function: log </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Formula:</span></span>
<span><span class="co">## abundance.est ~ s(x, y) + offset(off.set)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parametric coefficients:</span></span>
<span><span class="co">##             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">## (Intercept) -18.0234     0.4738  -38.04   &lt;2e-16 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Approximate significance of smooth terms:</span></span>
<span><span class="co">##          edf Ref.df    F  p-value    </span></span>
<span><span class="co">## s(x,y) 24.64  27.43 2.35 0.000289 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## R-sq.(adj) =  0.129   Deviance explained = 42.2%</span></span>
<span><span class="co">## -REML = 1043.6  Scale est. = 174.08    n = 387</span></span></code></pre>
<p>As is the resulting spatial smooth (though the resulting surface is somewhat “amplified”):</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/vis.gam.html" class="external-link">vis.gam</a></span><span class="op">(</span><span class="va">dsm.est.xy</span>, plot.type<span class="op">=</span><span class="st">"contour"</span>, view<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span>, asp<span class="op">=</span><span class="fl">1</span>, type<span class="op">=</span><span class="st">"response"</span>, zlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">300</span><span class="op">)</span>, contour.col<span class="op">=</span><span class="st">"black"</span>, n.grid<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p><img src="mexico-analysis_files/figure-html/visgam5-1.png"><!-- --></p>
</div>
<div class="section level3">
<h3 id="other-response-distributions">Other response distributions<a class="anchor" aria-label="anchor" href="#other-response-distributions"></a>
</h3>
<p>Often the quasi-Poisson distribution doesn’t give adequate flexibility and does not capture the overdispersion in the response data (see <a href="#model-checking">Model checking</a> and <a href="#model-selection">Model selection</a> below), so below we illustrate two additional distributions that can be used with count data.</p>
<p>For the models in this section, we’ll move back to the <code>count</code> response, though the estimated abundance would also work.</p>
<div class="section level4">
<h4 id="tweedie">Tweedie<a class="anchor" aria-label="anchor" href="#tweedie"></a>
</h4>
<p>Response distributions other than the quasi-Poisson can be used, for example the Tweedie distribution. The Tweedie distribution is available in <code>dsm</code> by setting <code>family=tw()</code>.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dsm.xy.tweedie</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/dsm.html">dsm</a></span><span class="op">(</span><span class="va">count</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span>, <span class="va">detfc.hr.null</span>, <span class="va">segdata</span>, <span class="va">obsdata</span>, family<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/Tweedie.html" class="external-link">tw</a></span><span class="op">(</span><span class="op">)</span>, method<span class="op">=</span><span class="st">"REML"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">dsm.xy.tweedie</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Family: Tweedie(p=1.347) </span></span>
<span><span class="co">## Link function: log </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Formula:</span></span>
<span><span class="co">## count ~ s(x, y) + offset(off.set)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parametric coefficients:</span></span>
<span><span class="co">##             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">## (Intercept) -17.2640     0.2363  -73.07   &lt;2e-16 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Approximate significance of smooth terms:</span></span>
<span><span class="co">##          edf Ref.df     F p-value  </span></span>
<span><span class="co">## s(x,y) 12.82  17.13 1.628  0.0562 .</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## R-sq.(adj) =  0.0684   Deviance explained = 26.8%</span></span>
<span><span class="co">## -REML = 351.49  Scale est. = 60.26     n = 387</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="negative-binomial">Negative binomial<a class="anchor" aria-label="anchor" href="#negative-binomial"></a>
</h4>
<p>Though not used here there are, similarly, two options for the negative binomial distribution: <code>negbin</code> and <code>nb</code>. The former requires the user specification single parameter <code>theta</code> or a range of values for the parameter (specified as a vector), the latter estimates the value of <code>theta</code> during the model fitting process (and is generally faster). The latter is recommended for most users.</p>
</div>
</div>
<div class="section level3">
<h3 id="other-spatial-modelling-options">Other spatial modelling options<a class="anchor" aria-label="anchor" href="#other-spatial-modelling-options"></a>
</h3>
<p>There is a large literature on spatial modelling using GAMs, much of which can be harnessed in a DSM context. Here are a few highlights.</p>
<div class="section level4">
<h4 id="soap-film-smoothing">Soap film smoothing<a class="anchor" aria-label="anchor" href="#soap-film-smoothing"></a>
</h4>
<p>To account for a complex region (e.g., a region that includes peninsulae) we can use the soap film smoother <span class="citation">(Simon N. Wood, Bravington, &amp; Hedley, 2008)</span>.</p>
<p>To use a soap film smoother for the spatial part of the model we must create a set of knots for the smoother to use. This is easily done using the <code><a href="../../reference/make.soapgrid.html">make.soapgrid()</a></code> function in <code>dsm</code>:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">soap.knots</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/make.soapgrid.html">make.soapgrid</a></span><span class="op">(</span><span class="va">survey.area</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">15</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>where the second argument specifies the number of points (in each direction) in the grid that will be used to create the knots (knots in the grid outside of <code>survey.area</code> are removed).</p>
<p>As we saw in the exploratory analysis, some of the transect lines are outside of the survey area. These will cause the soap film smoother to fail, so we remove them:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">segdata</span><span class="op">$</span><span class="va">x</span>; <span class="va">y</span><span class="op">&lt;-</span><span class="va">segdata</span><span class="op">$</span><span class="va">y</span></span>
<span><span class="va">onoff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/inSide.html" class="external-link">inSide</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span>, bnd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">survey.area</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span></span>
<span><span class="va">segdata.soap</span> <span class="op">&lt;-</span> <span class="va">segdata</span><span class="op">[</span><span class="va">onoff</span>,<span class="op">]</span></span></code></pre></div>
<p>Note that the <a href="https://github.com/dill/soap_checker" class="external-link"><code>soap_checker</code> script available here</a> can be useful in ensuring that the boundary, data and knots are in the correct format to use with the soap film smoother.</p>
<p>We can run a model with both the <code>depth</code> covariate along with a spatial (soap film) smooth. Note that the <code>k</code> argument now refers to the complexity of the boundary smooth in the soap film, and the complexity of the film is controlled by the knots given in the <code>xt</code> argument.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dsm.xy.tweedie.soap</span><span class="op">&lt;-</span><span class="fu"><a href="../../reference/dsm.html">dsm</a></span><span class="op">(</span><span class="va">count</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, bs<span class="op">=</span><span class="st">"so"</span>, k<span class="op">=</span><span class="fl">15</span>, xt<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>bnd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">survey.area</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">depth</span><span class="op">)</span>,</span>
<span>          family<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/Tweedie.html" class="external-link">tw</a></span><span class="op">(</span><span class="op">)</span>, method<span class="op">=</span><span class="st">"REML"</span>,</span>
<span>          <span class="va">detfc.hr.null</span>, <span class="va">segdata.soap</span>, <span class="va">obsdata</span>, knots<span class="op">=</span><span class="va">soap.knots</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">dsm.xy.tweedie.soap</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Family: Tweedie(p=1.356) </span></span>
<span><span class="co">## Link function: log </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Formula:</span></span>
<span><span class="co">## count ~ s(x, y, bs = "so", k = 15, xt = list(bnd = list(survey.area))) + </span></span>
<span><span class="co">##     s(depth) + offset(off.set)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parametric coefficients:</span></span>
<span><span class="co">##             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">## (Intercept)  -18.017      0.405  -44.49   &lt;2e-16 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Approximate significance of smooth terms:</span></span>
<span><span class="co">##            edf Ref.df     F  p-value    </span></span>
<span><span class="co">## s(x,y)   3.050 72.000 0.064 0.114944    </span></span>
<span><span class="co">## s(depth) 5.135  6.196 3.895 0.000793 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## R-sq.(adj) =  0.0653   Deviance explained = 33.1%</span></span>
<span><span class="co">## -REML = 339.26  Scale est. = 54.022    n = 365</span></span></code></pre>
</div>
</div>
</div>
<div class="section level2">
<h2 id="model-checking">Model checking<a class="anchor" aria-label="anchor" href="#model-checking"></a>
</h2>
<p>Fitting models is all well and good, but we’d like to confirm that the models we have are reasonable; <code>dsm</code> provides some functions for model checking.</p>
<p>We can use <code>gam.check</code> to generate diagnostic plots:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.check.html" class="external-link">gam.check</a></span><span class="op">(</span><span class="va">dsm.xy</span><span class="op">)</span></span></code></pre></div>
<p><img src="mexico-analysis_files/figure-html/dsm.xy-check-1.png"><!-- --></p>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Method: REML   Optimizer: outer newton</span></span>
<span><span class="co">## full convergence after 6 iterations.</span></span>
<span><span class="co">## Gradient range [-7.105973e-08,-9.826122e-09]</span></span>
<span><span class="co">## (score 936.0363 &amp; scale 94.3674).</span></span>
<span><span class="co">## Hessian positive definite, eigenvalue range [5.800328,192.5304].</span></span>
<span><span class="co">## Model rank =  30 / 30 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Basis dimension (k) checking results. Low p-value (k-index&lt;1) may</span></span>
<span><span class="co">## indicate that k is too low, especially if edf is close to k'.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##          k'  edf k-index p-value</span></span>
<span><span class="co">## s(x,y) 29.0 24.8    1.01    0.99</span></span></code></pre>
<p>These show that there is some deviation in the Q-Q plot. The “line” of points in the plot of the residuals vs. linear predictor plot corresponds to the zeros in the data.</p>
<p>Note that as well as the plots, <code>gam.check</code> also produces information about the model fitting. Of particular interest to us is the last few lines that tell us about the basis size.</p>
<p>The <code>k</code> parameter provided to <code>s</code> (and <code>te</code>) terms in <code>dsm</code> controls the complexity of the smooths in the model.</p>
<p>By setting the <code>k</code> parameter we specify the largest complexity for that smooth term in the model; as long as this is high enough, we can be sure that there is enough flexibility. In the output from <code>gam.check</code> above, we can see that there is a “p-value” calculated for the size of the basis, this can be a good guide as to whether the basis size needs to be increased.</p>
<p>The <code><a href="https://rdrr.io/pkg/mgcv/man/choose.k.html" class="external-link">?choose.k</a></code> manual page from <code>mgcv</code> gives further guidance and technical details on this matter.</p>
<p>We can look at the same model form but with a Tweedie distribution specified as the response:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.check.html" class="external-link">gam.check</a></span><span class="op">(</span><span class="va">dsm.xy.tweedie</span><span class="op">)</span></span></code></pre></div>
<p><img src="mexico-analysis_files/figure-html/dsm.xy.tweedie-check-1.png"><!-- --></p>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Method: REML   Optimizer: outer newton</span></span>
<span><span class="co">## full convergence after 8 iterations.</span></span>
<span><span class="co">## Gradient range [-1.513175e-06,3.981813e-06]</span></span>
<span><span class="co">## (score 351.486 &amp; scale 60.26034).</span></span>
<span><span class="co">## Hessian positive definite, eigenvalue range [0.6230615,103.5094].</span></span>
<span><span class="co">## Model rank =  30 / 30 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Basis dimension (k) checking results. Low p-value (k-index&lt;1) may</span></span>
<span><span class="co">## indicate that k is too low, especially if edf is close to k'.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##          k'  edf k-index p-value</span></span>
<span><span class="co">## s(x,y) 29.0 12.8    0.73    0.34</span></span></code></pre>
<p>The Q-Q plot now seems much better (closer to the <span class="math inline">\(y=x\)</span> line). In both plots the histogram of residuals is rather hard to interpret due to the large number of zeros in the data.</p>
<p>Further guidance on interpreting <code>gam.check</code> output can be found in <span class="citation">(S. N. Wood, 2017)</span>.</p>
<div class="section level4">
<h4 id="randomised-quantile-residuals">Randomised quantile residuals<a class="anchor" aria-label="anchor" href="#randomised-quantile-residuals"></a>
</h4>
<p>In the top right panel of the above <code>gam.check</code> plots the residuals vs. linear predictor plot includes a odd line of predictions. These are an artifact of the link function, showing the exact zeros in the data. These can be misleading and distracting, making it difficult to see whether residuals show heteroskedasticity.</p>
<p>Randomised quantile residuals <span class="citation">(Dunn &amp; Smyth, 1996)</span> avoid this issue by transforming the residuals to be exactly normally distributed. This makes the residuals vs. linear predictor plot much easier to interpret as it therefore doesn’t include the artifacts generated by the link function. These plots can be produced using <code>rqgam.check</code> in <code>dsm</code>:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/rqgam_check.html">rqgam_check</a></span><span class="op">(</span><span class="va">dsm.xy.tweedie</span><span class="op">)</span></span></code></pre></div>
<p><img src="mexico-analysis_files/figure-html/dsm.xy.tweedie-rqcheck-1.png"><!-- --></p>
<p>Here we can see that there is no issue with heteroskedasticity (no increase in spread in the residuals vs. linear predictor plot with increasing values of the linear predictor). One can also plot these residuals against covariate values to check for pattern in the residuals.</p>
<p>Note that in general, plots other than “Resids vs. linear pred.” should be interpreted with caution in the output of <code>rqgam.check</code> as the residuals generated are normal by construction (so for example the Q-Q plot and histogram of residuals will always look fine).</p>
</div>
</div>
<div class="section level2">
<h2 id="model-selection">Model selection<a class="anchor" aria-label="anchor" href="#model-selection"></a>
</h2>
<p>Assuming that models have “passed” the checks in <code>gam.check</code>, <code>rqgam.check</code> and are sufficiently flexible, we may be left with a choice of which model is “best”. There are several methods for choosing the best model – AIC, REML/GCV scores, deviance explained, full cross-validation with test data and so on.</p>
<p>Though this document does not intend to be a full analysis of the pantropical dolphin data, we can create a results table to compare the various models that have been fitted so far in terms of their abundance estimates and associated uncertainties.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># make a data.frame to print out</span></span>
<span><span class="va">mod_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"Model name"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"`dsm.xy`"</span>, <span class="st">"`dsm.xy.depth`"</span>, <span class="st">"`dsm.xy.tweedie`"</span>, <span class="st">"`dsm.xy.tweedie.soap`"</span>,</span>
<span>                                           <span class="st">"`dsm.est.xy`"</span><span class="op">)</span>,</span>
<span>                          <span class="st">"Description"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Bivariate smooth of location, quasipoisson"</span>,</span>
<span>                                            <span class="st">"Bivariate smooth of location, smooth of depth, quasipoisson"</span>,</span>
<span>                                            <span class="st">"Bivariate smooth of location, smooth of depth, Tweedie"</span>,</span>
<span>                                            <span class="st">"Soap film smooth of location, smooth of depth, Tweedie"</span>,</span>
<span>                                            <span class="st">"Bivariate smooth of location, smooth of depth, Tweedie, Beaufort covariate in detection function"</span><span class="op">)</span>,</span>
<span>                          <span class="st">"Deviance explained"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">dsm.xy</span>,</span>
<span>                                                                      <span class="va">dsm.xy.depth</span>,</span>
<span>                                                                      <span class="va">dsm.xy.tweedie</span>,</span>
<span>                                                                      <span class="va">dsm.xy.tweedie.soap</span><span class="op">)</span>,</span>
<span>                 <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="va">dev.expl</span><span class="op">*</span><span class="fl">100</span>,<span class="fl">2</span><span class="op">)</span>,<span class="st">"%"</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span>,<span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can then use the resulting <code>data.frame</code> to build a table of results using the <code>kable</code> function:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">kable</span><span class="op">(</span><span class="va">mod_results</span>, col.names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Model name"</span>, <span class="st">"Description"</span>, <span class="st">"Deviance explained"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="15%">
<col width="70%">
<col width="13%">
</colgroup>
<thead><tr class="header">
<th align="left">Model name</th>
<th align="left">Description</th>
<th align="left">Deviance explained</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><code>dsm.xy</code></td>
<td align="left">Bivariate smooth of location, quasipoisson</td>
<td align="left">43.38%</td>
</tr>
<tr class="even">
<td align="left"><code>dsm.xy.depth</code></td>
<td align="left">Bivariate smooth of location, smooth of depth, quasipoisson</td>
<td align="left">34.32%</td>
</tr>
<tr class="odd">
<td align="left"><code>dsm.xy.tweedie</code></td>
<td align="left">Bivariate smooth of location, smooth of depth, Tweedie</td>
<td align="left">26.78%</td>
</tr>
<tr class="even">
<td align="left"><code>dsm.xy.tweedie.soap</code></td>
<td align="left">Soap film smooth of location, smooth of depth, Tweedie</td>
<td align="left">33.05%</td>
</tr>
<tr class="odd">
<td align="left"><code>dsm.est.xy</code></td>
<td align="left">Bivariate smooth of location, smooth of depth, Tweedie, Beaufort covariate in detection function</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="abundance-estimation">Abundance estimation<a class="anchor" aria-label="anchor" href="#abundance-estimation"></a>
</h2>
<p>Once a model has been checked and selected, we can make predictions over the grid and calculate abundance. The offset is stored in the <code>area</code> column<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;An earlier version of this vignette incorrectly stated that the areas of the prediction cells were 444km&lt;span class="math inline"&gt;\(^2\)&lt;/span&gt;. This has been corrected. Thanks to Phil Bouchet for pointing this out.&lt;/p&gt;'><sup>3</sup></a>.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dsm.xy.pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">dsm.xy</span>, <span class="va">preddata</span>, <span class="va">preddata</span><span class="op">$</span><span class="va">area</span><span class="op">)</span></span></code></pre></div>
<p>Given predicted abundance estimates for each cell in the prediction grid, these are connected to the prediction grid object for mapping:</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prediction_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html" class="external-link">st_make_grid</a></span><span class="op">(</span><span class="va">area.sf.proj</span>, cellsize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9000</span>,<span class="fl">9000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">prediction_grid_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">st_sf</a></span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">prediction_grid</span><span class="op">)</span></span>
<span></span>
<span><span class="va">preddata_sf</span><span class="op">$</span><span class="va">Prediction_xy</span> <span class="op">&lt;-</span> <span class="va">dsm.xy.pred</span></span>
<span></span>
<span><span class="va">cropped_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_join</a></span><span class="op">(</span><span class="va">prediction_grid_sf</span>, <span class="va">preddata_sf</span>, join <span class="op">=</span> <span class="va">st_nearest_feature</span><span class="op">)</span></span>
<span><span class="va">cropped_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">cropped_grid</span>, <span class="va">area.sf.proj</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: attribute variables are assumed to be spatially constant throughout</span></span>
<span><span class="co">## all geometries</span></span></code></pre>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">cropped_grid</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Prediction_xy</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">segdata_sf</span>, fill<span class="op">=</span><span class="cn">NA</span>, color<span class="op">=</span><span class="st">"white"</span>, linewidth<span class="op">=</span><span class="fl">.001</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Spotted dolphins, Gulf of Mexico, abundance estimates"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Bivariate smooth of location, quasipoisson"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"viridis"</span>, direction <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">pred</span></span></code></pre></div>
<p><img src="mexico-analysis_files/figure-html/dsm.xy-preds-1.png"><!-- --></p>
<p>We can calculate abundance over the survey area by simply summing these predictions:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">dsm.xy.pred</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 28462.22</span></span></code></pre>
<p>We can compare this with a plot of the predictions from this <code>dsm.xy.depth</code>:</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dsm.xy.depth.pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">dsm.xy.depth</span>, <span class="va">preddata</span>, <span class="va">preddata</span><span class="op">$</span><span class="va">area</span><span class="op">)</span></span>
<span></span>
<span><span class="va">preddata_sf</span><span class="op">$</span><span class="va">Prediction_xy_depth</span> <span class="op">&lt;-</span> <span class="va">dsm.xy.depth.pred</span></span>
<span></span>
<span><span class="va">cropped_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_join</a></span><span class="op">(</span><span class="va">prediction_grid_sf</span>, <span class="va">preddata_sf</span>, join <span class="op">=</span> <span class="va">st_nearest_feature</span><span class="op">)</span></span>
<span><span class="va">cropped_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">cropped_grid</span>, <span class="va">area.sf.proj</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: attribute variables are assumed to be spatially constant throughout</span></span>
<span><span class="co">## all geometries</span></span></code></pre>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">cropped_grid</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Prediction_xy_depth</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">segdata_sf</span>, fill<span class="op">=</span><span class="cn">NA</span>, color<span class="op">=</span><span class="st">"white"</span>, linewidth<span class="op">=</span><span class="fl">.001</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Spotted dolphins, Gulf of Mexico, abundance estimates"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Bivariate smooth of location, smooth of depth, quasipoisson"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"viridis"</span>, direction <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">pred</span></span></code></pre></div>
<p><img src="mexico-analysis_files/figure-html/dsm.xy.depth-preds-1.png"><!-- --></p>
<p>We can see the inclusion of depth into the model has had a noticeable effect on the distribution (note the difference in legend scale between the two plots). We can again also look at the total abundance:</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">dsm.xy.depth.pred</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 27084.54</span></span></code></pre>
<p>Here we see that there is not much of a change in the abundance, so in terms of abundance alone there isn’t much between the two models. Next we’ll go on to look at variance next where we can see bigger differences between the models.</p>
</div>
<div class="section level2">
<h2 id="variance-estimation">Variance estimation<a class="anchor" aria-label="anchor" href="#variance-estimation"></a>
</h2>
<p>Obviously point estimates of abundance are important, but we should also calculate uncertainty around these abundance estimates. Fortunately <code>dsm</code> provides functions to perform these calculations and display the resulting uncertainty estimates.</p>
<p>There are two approaches to estimating the uncertainty of an abundance estimate in <code>dsm</code>.</p>
<ul>
<li>
<code>dsm_var_gam</code> which assumes that the spatial model and detection function parts of the model are independent of each other. In this case the squared coefficients of variation for each model component are added.</li>
<li>
<code>dsm_var_prop</code> which takes into account the fact that detection probability may be correlated with the spatial part of the model. It uses methods described in <span class="citation">(Bravington, Miller, &amp; Hedley, 2021)</span>.</li>
</ul>
<p><code>dsm_var_prop</code> can only be applied when there is a covariate in the detection function that varies at the level of the segments, and is recorded at each segment (for example Beaufort). We don’t have that situation here, so we opt for <code>dsm_var_gam</code>.</p>
<p>Both methods estimate the variance of the abundance for each element in the list provided in <code>pred.data</code>. In our case we wish to obtain an abundance for each of the prediction cells, so we use <code>split</code> to chop our data set into list elements to give to <code>dsm_var_gam</code> (or <code>dsm_var_prop</code>).</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preddata.var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">preddata</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">preddata</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dsm.xy.var</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/dsm_var_gam.html">dsm_var_gam</a></span><span class="op">(</span><span class="va">dsm.xy</span>, pred.data<span class="op">=</span><span class="va">preddata.var</span>,</span>
<span>                          off.set<span class="op">=</span><span class="va">preddata</span><span class="op">$</span><span class="va">area</span><span class="op">)</span></span></code></pre></div>
<p>Calling <code>summary</code> will give some information about uncertainty estimation:</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">dsm.xy.var</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Summary of uncertainty in a density surface model calculated</span></span>
<span><span class="co">##  analytically for GAM, with delta method</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Approximate asymptotic confidence interval:</span></span>
<span><span class="co">##     2.5%     Mean    97.5% </span></span>
<span><span class="co">## 13133.77 28462.22 61680.55 </span></span>
<span><span class="co">## (Using log-Normal approximation)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate                 : 28462.22 </span></span>
<span><span class="co">## CV of detection function       : 0.3762887 </span></span>
<span><span class="co">## CV from GAM                    : 0.164 </span></span>
<span><span class="co">## Total standard error           : 11682.74 </span></span>
<span><span class="co">## Total coefficient of variation : 0.4105</span></span></code></pre>
<p>We can also make a plot of the CVs (with transect lines and observations overlaid) using the following code.</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preddata_sf</span><span class="op">$</span><span class="va">CV</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">dsm.xy.var</span><span class="op">$</span><span class="va">pred.var</span><span class="op">)</span><span class="op">/</span><span class="va">preddata_sf</span><span class="op">$</span><span class="va">Prediction_xy</span></span>
<span></span>
<span><span class="va">cropped_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_join</a></span><span class="op">(</span><span class="va">prediction_grid_sf</span>, <span class="va">preddata_sf</span>, join <span class="op">=</span> <span class="va">st_nearest_feature</span><span class="op">)</span></span>
<span><span class="va">cropped_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">cropped_grid</span>, <span class="va">area.sf.proj</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: attribute variables are assumed to be spatially constant throughout</span></span>
<span><span class="co">## all geometries</span></span></code></pre>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CV</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">cropped_grid</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">CV</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">segdata_sf</span>, fill<span class="op">=</span><span class="cn">NA</span>, color<span class="op">=</span><span class="st">"white"</span>, linewidth<span class="op">=</span><span class="fl">.001</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Spotted dolphins, Gulf of Mexico, uncertainty (CV)"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Bivariate smooth of location, quasipoisson"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"viridis"</span>, direction <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">CV</span></span></code></pre></div>
<p><img src="mexico-analysis_files/figure-html/dsm.xyvarplot-1.png"><!-- --></p>
<p>Note the increase in CV away from the transect lines.</p>
<p>We can revisit the model that included both depth and location smooths and observe that the coefficient of variation for that model is larger than that of the model with only the location smooth.</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dsm.xy.depth.var</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/dsm_var_gam.html">dsm_var_gam</a></span><span class="op">(</span><span class="va">dsm.xy.depth</span>, pred.data<span class="op">=</span><span class="va">preddata.var</span>,</span>
<span>                                off.set<span class="op">=</span><span class="va">preddata</span><span class="op">$</span><span class="va">area</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">dsm.xy.depth.var</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Summary of uncertainty in a density surface model calculated</span></span>
<span><span class="co">##  analytically for GAM, with delta method</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Approximate asymptotic confidence interval:</span></span>
<span><span class="co">##     2.5%     Mean    97.5% </span></span>
<span><span class="co">## 12407.79 27084.54 59121.90 </span></span>
<span><span class="co">## (Using log-Normal approximation)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Point estimate                 : 27084.54 </span></span>
<span><span class="co">## CV of detection function       : 0.3762887 </span></span>
<span><span class="co">## CV from GAM                    : 0.1741 </span></span>
<span><span class="co">## Total standard error           : 11229.87 </span></span>
<span><span class="co">## Total coefficient of variation : 0.4146</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="conclusions">Conclusions<a class="anchor" aria-label="anchor" href="#conclusions"></a>
</h2>
<p>This document has outlined an analysis of spatially-explicit distance sampling data using the <code>dsm</code> package. Note that there are many possible models that can be fitted using <code>dsm</code> and that the aim here was to show just a few of the options. Results from the models can be rather different, so care must be taken in performing model selection, discrimination and criticism.</p>
</div>
<div class="section level2">
<h2 id="software">Software<a class="anchor" aria-label="anchor" href="#software"></a>
</h2>
<ul>
<li>
<code>Distance</code> is available at <a href="http://github.com/DistanceDevelopment/Distance" class="external-link">http://github.com/DistanceDevelopment/Distance</a> as well as on CRAN.</li>
<li>
<code>dsm</code> is available at <a href="http://github.com/DistanceDevelopment/dsm" class="external-link">http://github.com/DistanceDevelopment/dsm</a>, as well as on CRAN.</li>
</ul>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0" line-spacing="2">
<div id="ref-bivand_applied_2008" class="csl-entry">
Bivand, R. S., Pebesma, E. J., &amp; Gómez-Rubio, V. (2008). <em>Applied spatial data analysis with <span>R</span></em>. Retrieved from <a href="https://books.google.co.uk/books?id=4gg8yx_lcj0C" class="external-link">https://books.google.co.uk/books?id=4gg8yx_lcj0C</a>
</div>
<div id="ref-bravington_variance_2021" class="csl-entry">
Bravington, M. V., Miller, D. L., &amp; Hedley, S. L. (2021). Variance <span>Propagation</span> for <span>Density Surface Models</span>. <em>Journal of Agricultural, Biological and Environmental Statistics</em>, <em>26</em>, 306–323. <a href="https://doi.org/10.1007/s13253-021-00438-2" class="external-link">https://doi.org/10.1007/s13253-021-00438-2</a>
</div>
<div id="ref-dunn_randomized_1996" class="csl-entry">
Dunn, P. K., &amp; Smyth, G. K. (1996). Randomized quantile residuals. <em>Journal of Computational and Graphical Statistics</em>, <em>5</em>(3), 236–244. Retrieved from <a href="http://www.jstor.org/stable/1390802" class="external-link">http://www.jstor.org/stable/1390802</a>
</div>
<div id="ref-hedley_spatial_2004" class="csl-entry">
Hedley, S. L., &amp; Buckland, S. T. (2004). Spatial models for line transect sampling. <em>Journal of Agricultural, Biological, and Environmental Statistics</em>, <em>9</em>(2), 181–199. <a href="https://doi.org/10.1198/1085711043578" class="external-link">https://doi.org/10.1198/1085711043578</a>
</div>
<div id="ref-miller_spatial_2013" class="csl-entry">
Miller, D. L., Burt, M. L., Rexstad, E. A., &amp; Thomas, L. (2013). Spatial models for distance sampling data: Recent developments and future directions. <em>Methods in Ecology and Evolution</em>, <em>4</em>(11), 1001–1010. <a href="https://doi.org/10.1111/2041-210X.12105" class="external-link">https://doi.org/10.1111/2041-210X.12105</a>
</div>
<div id="ref-wood_generalized_2017" class="csl-entry">
Wood, S. N. (2017). <em>Generalized additive models. An introduction with <span>R</span></em> (2nd ed.). CRC Press.
</div>
<div id="ref-wood_soap_2008" class="csl-entry">
Wood, Simon N., Bravington, M. V., &amp; Hedley, S. L. (2008). Soap film smoothing. <em>Journal of the Royal Statistical Society: Series B (Statistical Methodology)</em>, <em>70</em>(5), 931–955. <a href="https://doi.org/10.1111/j.1467-9868.2008.00665.x" class="external-link">https://doi.org/10.1111/j.1467-9868.2008.00665.x</a>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>We improve our site and software support by using cookies to see <br> how you use our website.</p>
</div>

<div class="pkgdown-footer-right">
  <p>If you wish to donate to development and maintenance, please <a href="mailto:distance@st-andrews.ac.uk">email us</a>.</p>
</div>

    </footer>
</div>





  </body>
</html>
