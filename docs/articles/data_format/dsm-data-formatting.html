<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>`dsm` data formatting example • dsm</title>
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../deps/search-1.0.0/fuse.min.js"></script><script src="../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="`dsm` data formatting example">
<meta name="description" content="'Making sure your data is in the correct format for `dsm`.'
">
<meta property="og:description" content="'Making sure your data is in the correct format for `dsm`.'
">
<script type="text/javascript"> (function(c,l,a,r,i,t,y){ c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)}; t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i; y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);})(window, document, "clarity", "script","maw5mo10ad");</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../../index.html">dsm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.3.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../../articles/data_format/dsm-data-formatting.html">`dsm` data formatting example</a></li>
    <li><a class="dropdown-item" href="../../articles/lines_gomex/mexico-analysis.html">Example `dsm` analysis: pantropical dolphins in the Gulf of Mexico</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://twitter.com/distancesamp" aria-label="Twitter"><span class="fa fa-twitter"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/DistanceDevelopment/dsm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>`dsm` data formatting example</h1>
                        <h4 data-toc-skip class="author">David L Miller</h4>
            <address class="author_afil">
      CREEM, University of St Andrews<br><h4 data-toc-skip class="date">August 2025</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/DistanceDevelopment/dsm/blob/HEAD/vignettes/data_format/dsm-data-formatting.Rmd" class="external-link"><code>vignettes/data_format/dsm-data-formatting.Rmd</code></a></small>
      <div class="d-none name"><code>dsm-data-formatting.Rmd</code></div>
    </address>
</div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>dsm</code> package expects data to be in a specific format. In this example I’ll show how to get data into that format and give some explanation as to <em>why</em> each of these requirements exist.</p>
<p>I recommend getting to grips with fitting models in <code>dsm</code> before reading this tutorial so you know what the end point will look like before trying to grapple with the data. An example for <a href="http://distancedevelopment.github.io/dsm/articles/lines_gomex/mexico-analysis.html" class="external-link">Gulf of Mexico pantropical spotted dolphins is available here</a>.</p>
</div>
<div class="section level2">
<h2 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<p>To run the code below, you will need to have the <code>ggplot2</code> and <code>sf</code> libraries installed. You can do this with the following code:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ggplot2"</span>, <span class="st">"sf"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The Rhode Island data required downloaded below:</p>
<ul>
<li><a href="data/loons.csv">loon observations</a></li>
<li><a href="data/ri_coast.dbf">coastline dbf</a></li>
<li><a href="data/ri_coast.prj">coastline projection</a></li>
<li><a href="data/ri_coast.shp">coastline shapefile</a></li>
<li><a href="data/ri_coast.shx">coastline shx</a></li>
<li><a href="data/ri_transects.dbf">transects dbf</a></li>
<li><a href="data/ri_transects.prj">transects projection</a></li>
<li><a href="data/ri_transects.shp">transects shapefile</a></li>
<li><a href="data/ri_transects.shx">transects shx</a></li>
</ul>
<p>These should be placed in a folder called <code>data</code> for the code below to work.</p>
</div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>When we collect distance sampling data, we need to record (1) the distance to an observation (along with other detectability covariates like weather), (2) the transect we are currently on, and (3) how much effort we expended on that transect (its length or number of visits).</p>
<p>If we want to fit a DSM that information needs to be expanded to include where on the transect we are too, so we can build the spatial model. For point transects, this is simple as we are always at the point, but for line transects we need to know the position of the detection too (or equivalently, how far along the transect we are).</p>
<p>More abstractly, we need information about both detections and effort. We also need to link these two. In <code>dsm</code> we use three objects to hold this information:</p>
<ul>
<li>the fitted detection function (argument <code>ddf.obj</code>) holds all the detections but ignores spatial information</li>
<li>the “segments” (argument <code>segment.data</code>) holds the chunks of effort (parts of the transect or point visits) and their locations. It might also include environmental covariate information.</li>
<li>a table linking the above two (argument <code>observation.data</code>), making sure each detection has a corresponding segment.</li>
</ul>
<div class="float">
<img src="images/dsm_tables.png" style="width:100.0%" alt="Correspondence between dsm tables"><div class="figcaption">Correspondence between <code>dsm</code> tables</div>
</div>
<p>The above image gives an overview of how the different <code>data.frames</code> interact, along with how that corresponds to the real life situation of collecting data on a transect.</p>
<p>The rest of this example goes through each table in turn, explaining their construction.</p>
</div>
<div class="section level2">
<h2 id="table-construction">Table construction<a class="anchor" aria-label="anchor" href="#table-construction"></a>
</h2>
<div class="section level3">
<h3 id="detection-data">Detection data<a class="anchor" aria-label="anchor" href="#detection-data"></a>
</h3>
<p>The data requirements are very similar to those for packages <code>mrds</code> and <code>Distance</code>. In both cases, each detection has a corresponding row. For an analysis using <code>dsm</code> we have additional requirements in the data (which can be auto-generated by <code>Distance</code> but we recommend against this to ensure that you know that records link up correctly).</p>
<p>For <code>Distance</code> we need:</p>
<ul>
<li>
<code>distance</code> : the distance to the detection</li>
<li>
<code>object</code> : a unique detection identifier (which will link to the observation table)</li>
<li>
<code>size</code> : the number of individuals in the detection (1 if objects occur alone)</li>
</ul>
<p><code>mrds</code> requires the following extra columns (to allow for double observer surveys):</p>
<ul>
<li>
<code>detected</code> : 1 if detected by the observer and 0 if missed (always 1 for single observer)</li>
<li>
<code>observer</code> : observer number (1 or 2) (always 1 for single observer)</li>
</ul>
<p>If other covariates that affect detectability are recorded (e.g., sex or weather) then these can be included in this data for analysis in <code>mrds</code> or <code>Distance</code>.</p>
<p>Once the model is fitted, we deal only with that fitted model object in the <code>dsm</code> analysis.</p>
</div>
<div class="section level3">
<h3 id="segment-data">Segment data<a class="anchor" aria-label="anchor" href="#segment-data"></a>
</h3>
<p>I will use the term “segment” here to refer to both points for point transects and small chunks of transect for the line transect case. I’ll assume that you’ve already segmented your lines while first describing the data format, then go on to an example of how to segment line transect data.</p>
<p>The <code>data.frame</code> required for the segments needs the following columns:</p>
<ul>
<li>
<code>Effort</code> : the effort expended on this segment (either the length of the segment for lines, or the number of visits for points)</li>
<li>
<code>Sample.Label</code> : a unique identifier for the segment (if you are engaged in a complicated survey, this might take a format like “<code>YEAR</code>-<code>AREA</code>-<code>LINE</code>-<code>SEGMENT</code>”, so you have labels like “<code>2020-North-A-15</code>”, which can be useful to keep track of where data came from later).</li>
</ul>
<p>In addition, environmental covariates like location and relevant covariates (sea surface temperature, foliage type, altitude, bathymetry, etc) can be included in this <code>data.frame</code> if they are to be used in the spatial model.</p>
<div class="section level4">
<h4 id="segmenting">Segmenting<a class="anchor" aria-label="anchor" href="#segmenting"></a>
</h4>
<p>If you have data as lines and you want to chop them up into segments, this section will give some sample R code to do this. How things work is extremely dependent on the input data, but hopefully this gives a template for what you want to do at least.</p>
<p><em>Before you jump in</em>: If you are fluent in ArcGIS or QGIS I recommend doing this task in the software you are familiar with at first. A simple guide to doing this task in <a href="https://www.northrivergeographic.com/qgis-split-a-line-at-an-interval" class="external-link">QGIS is here</a> and for <a href="https://mgel.env.duke.edu/mget/" class="external-link">ArcGIS I recommend the MGET toolbox</a>.</p>
<p>As an example, we will look at an aerial survey of seabirds off the coast of Rhode Island, USA. Data from these surveys were collected by the University of Rhode Island and analysed in <span class="citation">K. Winiarski, Miller, Paton, &amp; McWilliams (2013)</span>, <span class="citation">K. J. Winiarski, Burt, et al. (2014)</span> and <span class="citation">K. J. Winiarski, Miller, Paton, &amp; McWilliams (2014)</span>. I have the transects saved as a shapefile that I will then “chop-up” into segments. To start with let’s plot the data with the coastline:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># coast data, just for reference</span></span>
<span><span class="va">coastline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="st">"data/ri_coast.shp"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># our transect lines</span></span>
<span><span class="va">transects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="st">"data/ri_transects.shp"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># now make the plot</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># geom_sf knows what to do with spatial data</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">coastline</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">transects</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour<span class="op">=</span><span class="va">Transect</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># chop to be on a better scale</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">72</span>, <span class="op">-</span><span class="fl">70.8</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">40.8</span>, <span class="fl">41.5</span><span class="op">)</span>, expand<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># make the plot look simpler</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre></div>
<p><img src="dsm-data-formatting_files/figure-html/unnamed-chunk-4-1.png"><!-- --></p>
<p>In the above code we have loaded the <a href="https://r-spatial.github.io/sf/" class="external-link"><code>sf</code> package</a>. This is the package we will use to do most of our spatial work in segmenting the data. It has most of the tools expected from a GIS, though the package is still being developed so its functionality is always increasing.</p>
<p>Investigating the <code>transects</code> data we loaded, we can see it consists of a <code>data.frame</code> with some extra bits (the spatial information, including locations (<code>geometry</code>) and projection (<code>CRS</code>)):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">transects</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 26 features and 1 field</span></span>
<span><span class="co">## Geometry type: LINESTRING</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -71.86948 ymin: 40.82944 xmax: -70.8944 ymax: 41.46521</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 26 × 2</span></span></span>
<span><span class="co">##    Transect                                 geometry</span></span>
<span><span class="co">##       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                         <span style="color: #949494; font-style: italic;">&lt;LINESTRING [°]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span>        1 (-71.86948 41.29969, -71.86581 41.25891)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span>        2  (-71.82872 41.30738, -71.82145 41.2258)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span>        3 (-71.78805 41.31562, -71.75676 40.94846)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span>        4 (-71.74674 41.31728, -71.71394 40.92971)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span>        5  (-71.70589 41.3241, -71.67156 40.91612)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span>        6 (-71.66578 41.33943, -71.62329 40.82944)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span>        7   (-71.5435 41.36397, -71.5064 40.91516)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span>        8  (-71.5015 41.35994, -71.45266 40.82978)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span>        9 (-71.46131 41.37378, -71.42458 40.92496)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span>       10   (-71.421 41.38723, -71.37562 40.83641)</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 16 more rows</span></span></span></code></pre>
<p>We have one row per transect (for a total of 24 transects), each of which consists of a line joining the start and end points that make up the transects. If we want we can plot individual rows via <code>plot(transects[1,])</code>; this can be useful to check that each row is a single line, or if further processing is needed (this can be tricky and is not covered in this tutorial but see “More information” below).</p>
<p>This data looks in good shape, so we can use the <code>st_segmentize</code> function to take each transect and make segments from them. To make sure everything works correctly, we need to project the data first. Here I’m using an appropriate projected coordinate system (EPSG code 6348), which is the Rhode Island State Plane.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># project transects</span></span>
<span><span class="va">transects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">transects</span>, <span class="fl">6348</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># do the segmenting</span></span>
<span><span class="va">segs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_segmentize</a></span><span class="op">(</span><span class="va">transects</span>, dfMaxLength<span class="op">=</span><span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="st">"metres"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># transform back to lat/long</span></span>
<span><span class="va">segs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">segs</span>, <span class="fl">4326</span><span class="op">)</span></span>
<span><span class="va">transects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">transects</span>, <span class="fl">4326</span><span class="op">)</span></span></code></pre></div>
<p>Here we know the truncation used for the detection function was 1000m (the distances were collected in bins and this was the further bin), and since we’re trying to make our segments approximately square, we set the length to be twice that (since the truncation applies to either side of the transect), so 2000m.</p>
<p>Looking at what that did:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">segs</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 26 features and 1 field</span></span>
<span><span class="co">## Geometry type: LINESTRING</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -71.86948 ymin: 40.82944 xmax: -70.8944 ymax: 41.46521</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 26 × 2</span></span></span>
<span><span class="co">##    Transect                                                             geometry</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                                                     <span style="color: #949494; font-style: italic;">&lt;LINESTRING [°]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span>        1 (-71.86948 41.29969, -71.86826 41.2861, -71.86703 41.2725, -71.8658…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span>        2 (-71.82872 41.30738, -71.82727 41.29106, -71.82581 41.27475, -71.82…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span>        3 (-71.78805 41.31562, -71.78654 41.29813, -71.78505 41.28065, -71.78…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span>        4 (-71.74674 41.31728, -71.74524 41.29967, -71.74373 41.28205, -71.74…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span>        5 (-71.70589 41.3241, -71.70438 41.30636, -71.70288 41.28863, -71.701…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span>        6 (-71.66578 41.33943, -71.6643 41.32185, -71.66283 41.30426, -71.661…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span>        7 (-71.5435 41.36397, -71.542 41.34602, -71.54051 41.32807, -71.53901…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span>        8 (-71.5015 41.35994, -71.49986 41.34227, -71.49821 41.3246, -71.4965…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span>        9 (-71.46131 41.37378, -71.45983 41.35583, -71.45835 41.33788, -71.45…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span>       10 (-71.421 41.38723, -71.41952 41.36946, -71.41804 41.3517, -71.41656…</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 16 more rows</span></span></span></code></pre>
<p>See now that each row has many coordinates attached to it, just looking at the first row (transect 1) and comparing the coordinates between <code>transects</code> and <code>segs</code></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">transects</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              X        Y L1</span></span>
<span><span class="co">## [1,] -71.86948 41.29969  1</span></span>
<span><span class="co">## [2,] -71.86581 41.25891  1</span></span></code></pre>
<p><code>transects</code> has just two coordinates in it (the start and end points of the line). Whereas:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">segs</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              X        Y L1</span></span>
<span><span class="co">## [1,] -71.86948 41.29969  1</span></span>
<span><span class="co">## [2,] -71.86826 41.28610  1</span></span>
<span><span class="co">## [3,] -71.86703 41.27250  1</span></span>
<span><span class="co">## [4,] -71.86581 41.25891  1</span></span></code></pre>
<p><code>segs</code> has 5, corresponding to our segment cut points.</p>
<p>We now need to break up the rows of <code>segs</code> into multiple rows, one per segment. This is a bit fiddly. We use a function provided by <a href="https://dieghernan.github.io" class="external-link"><code>dieghernan</code></a> on <a href="https://dieghernan.github.io/201905_Cast-to-subsegments/" class="external-link">their site</a> to do this. We first load the function (don’t worry about understanding the code!):</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stdh_cast_substring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span> <span class="op">=</span> <span class="st">"MULTILINESTRING"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ggg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry_type.html" class="external-link">st_geometry_type</a></span><span class="op">(</span><span class="va">ggg</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"POLYGON"</span>, <span class="st">"LINESTRING"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Input should be  LINESTRING or POLYGON"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">ggg</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sub</span> <span class="op">&lt;-</span> <span class="va">ggg</span><span class="op">[</span><span class="va">k</span><span class="op">]</span></span>
<span>    <span class="va">geom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>      <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">sub</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>      <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">sub</span><span class="op">)</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">sub</span><span class="op">)</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_multilinestring</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html" class="external-link">st_sfc</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">k</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">endgeom</span> <span class="op">&lt;-</span> <span class="va">geom</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">endgeom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">endgeom</span>, <span class="va">geom</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">endgeom</span> <span class="op">&lt;-</span> <span class="va">endgeom</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html" class="external-link">st_sfc</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">==</span> <span class="st">"sf"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">endgeom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_set_geometry</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">endgeom</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">to</span> <span class="op">==</span> <span class="st">"LINESTRING"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">endgeom</span> <span class="op">&lt;-</span> <span class="va">endgeom</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="st">"LINESTRING"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">endgeom</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can then use it to separate the segments and look at the results:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">segs</span> <span class="op">&lt;-</span> <span class="fu">stdh_cast_substring</span><span class="op">(</span><span class="va">segs</span>, to<span class="op">=</span><span class="st">"LINESTRING"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in st_cast.sf(., "LINESTRING"): repeating attributes for all</span></span>
<span><span class="co">## sub-geometries for which they may not be constant</span></span></code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">segs</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 590 features and 1 field</span></span>
<span><span class="co">## Geometry type: LINESTRING</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -71.86948 ymin: 40.82944 xmax: -70.8944 ymax: 41.46521</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 590 × 2</span></span></span>
<span><span class="co">##    Transect                                 geometry</span></span>
<span><span class="co">##       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                         <span style="color: #949494; font-style: italic;">&lt;LINESTRING [°]&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span>        1  (-71.86948 41.29969, -71.86826 41.2861)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span>        1   (-71.86826 41.2861, -71.86703 41.2725)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span>        1  (-71.86703 41.2725, -71.86581 41.25891)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span>        2 (-71.82872 41.30738, -71.82727 41.29106)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span>        2 (-71.82727 41.29106, -71.82581 41.27475)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span>        2 (-71.82581 41.27475, -71.82436 41.25843)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span>        2  (-71.82436 41.25843, -71.8229 41.24212)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span>        2   (-71.8229 41.24212, -71.82145 41.2258)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span>        3 (-71.78805 41.31562, -71.78654 41.29813)</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span>        3 (-71.78654 41.29813, -71.78505 41.28065)</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 580 more rows</span></span></span></code></pre>
<p>We now have 590 segments between 1km and 2km long. We can check the lengths using the <code>st_length</code> function and plot a histogram of the segment lengths:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_length</a></span><span class="op">(</span><span class="va">segs</span><span class="op">)</span>, xlab<span class="op">=</span><span class="st">"Segment lengths (m)"</span>, main<span class="op">=</span><span class="st">""</span><span class="op">)</span></span></code></pre></div>
<p><img src="dsm-data-formatting_files/figure-html/length-segs-1.png"><!-- --></p>
<p>Note that in setting the <code>dfMaxLength</code> argument to <code>st_segmentize</code> we are giving a rough guide to the segment length and the algorithm inside <code>st_segmentize</code> tries to get segments to be as equal in length as possible (note the <span class="math inline">\(x\)</span> axis in the histogram).</p>
<p>Note also that the <code>Transect</code> column in <code>segs</code> now has duplicate entries as each transect has multiple segments in it. We can now create our required columns for <code>dsm</code>.</p>
<p>First, the <code>Effort</code> column can be generated using <code>st_length</code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">segs</span><span class="op">$</span><span class="va">Effort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_length</a></span><span class="op">(</span><span class="va">segs</span><span class="op">)</span></span></code></pre></div>
<p>Then we can generate the <code>Sample.Labels</code>. Here I’ll use a more complicated naming scheme to show how that’s done, but one could simply write <code>segs$Sample.Label &lt;- 1:nrow(segs)</code> and that would be sufficient. Instead, I would like to have my <code>Sample.Label</code> be the “<code>YEAR</code>-<code>AREA</code>-<code>LINE</code>-<code>SEGMENT</code>” scheme I suggested above.</p>
<p>There are fancier ways to do this, but for clarity, let’s use a <code>for</code> loop:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create a dummy column that we can fill in as we go</span></span>
<span><span class="va">segs</span><span class="op">$</span><span class="va">Sample.Label</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="co"># set the year and area once for this data</span></span>
<span><span class="va">year</span> <span class="op">&lt;-</span> <span class="fl">2010</span></span>
<span><span class="va">area</span> <span class="op">&lt;-</span> <span class="st">"RI"</span></span>
<span></span>
<span><span class="co"># loop over the transect IDs</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">this_transect</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">segs</span><span class="op">$</span><span class="va">Transect</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># how many segments in this transect?</span></span>
<span>  <span class="va">n_segs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">segs</span>, <span class="va">Transect</span><span class="op">==</span><span class="va">this_transect</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># generate the n_segs labels that we need</span></span>
<span>  <span class="va">segs</span><span class="op">$</span><span class="va">Sample.Label</span><span class="op">[</span><span class="va">segs</span><span class="op">$</span><span class="va">Transect</span><span class="op">==</span><span class="va">this_transect</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">area</span>, <span class="va">this_transect</span>,</span>
<span>                                                           <span class="fl">1</span><span class="op">:</span><span class="va">n_segs</span>, sep<span class="op">=</span><span class="st">"-"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now we can check that looks right:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">segs</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 590 features and 3 fields</span></span>
<span><span class="co">## Geometry type: LINESTRING</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -71.86948 ymin: 40.82944 xmax: -70.8944 ymax: 41.46521</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 590 × 4</span></span></span>
<span><span class="co">##    Transect                                 geometry Effort Sample.Label</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                         <span style="color: #949494; font-style: italic;">&lt;LINESTRING [°]&gt;</span>    <span style="color: #949494;">[m]</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span>        1  (-71.86948 41.29969, -71.86826 41.2861)  <span style="text-decoration: underline;">1</span>515. 2010-RI-1-1 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span>        1   (-71.86826 41.2861, -71.86703 41.2725)  <span style="text-decoration: underline;">1</span>515. 2010-RI-1-2 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span>        1  (-71.86703 41.2725, -71.86581 41.25891)  <span style="text-decoration: underline;">1</span>515. 2010-RI-1-3 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span>        2 (-71.82872 41.30738, -71.82727 41.29106)  <span style="text-decoration: underline;">1</span>818. 2010-RI-2-1 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span>        2 (-71.82727 41.29106, -71.82581 41.27475)  <span style="text-decoration: underline;">1</span>818. 2010-RI-2-2 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span>        2 (-71.82581 41.27475, -71.82436 41.25843)  <span style="text-decoration: underline;">1</span>818. 2010-RI-2-3 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span>        2  (-71.82436 41.25843, -71.8229 41.24212)  <span style="text-decoration: underline;">1</span>818. 2010-RI-2-4 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span>        2   (-71.8229 41.24212, -71.82145 41.2258)  <span style="text-decoration: underline;">1</span>818. 2010-RI-2-5 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span>        3 (-71.78805 41.31562, -71.78654 41.29813)  <span style="text-decoration: underline;">1</span>948. 2010-RI-3-1 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span>        3 (-71.78654 41.29813, -71.78505 41.28065)  <span style="text-decoration: underline;">1</span>948. 2010-RI-3-2 </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 580 more rows</span></span></span></code></pre>
<p>With the required columns taken care of, we can also calculate the centroids of our segments to get the locations of each segment to use in the spatial model. Handily we can use <code>st_centroid</code> to do this in one step and keep all our data at the same time.</p>
<p>We get a warning about how centroids might not be calculated correctly when latitude/longitude are used. So again we need to project the data first (to Rhode Island State Plane) for this step using <code>st_transform</code>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># save the line version of segs for plotting later</span></span>
<span><span class="va">segs_lines</span> <span class="op">&lt;-</span> <span class="va">segs</span></span>
<span></span>
<span><span class="co"># project segs</span></span>
<span><span class="va">segs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">segs</span>, <span class="fl">6348</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># find centroids</span></span>
<span><span class="va">segs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="va">segs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: st_centroid assumes attributes are constant over geometries</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># project back to lat/long</span></span>
<span><span class="va">segs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">segs</span>, <span class="fl">4326</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># how does that look?</span></span>
<span><span class="va">segs</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 590 features and 3 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -71.86887 ymin: 40.83823 xmax: -70.89506 ymax: 41.45646</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 590 × 4</span></span></span>
<span><span class="co">##    Transect             geometry Effort Sample.Label</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;POINT [°]&gt;</span>    <span style="color: #949494;">[m]</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span>        1 (-71.86887 41.29289)  <span style="text-decoration: underline;">1</span>515. 2010-RI-1-1 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span>        1  (-71.86764 41.2793)  <span style="text-decoration: underline;">1</span>515. 2010-RI-1-2 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span>        1  (-71.86642 41.2657)  <span style="text-decoration: underline;">1</span>515. 2010-RI-1-3 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span>        2 (-71.82799 41.29922)  <span style="text-decoration: underline;">1</span>818. 2010-RI-2-1 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span>        2  (-71.82654 41.2829)  <span style="text-decoration: underline;">1</span>818. 2010-RI-2-2 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span>        2 (-71.82508 41.26659)  <span style="text-decoration: underline;">1</span>818. 2010-RI-2-3 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span>        2 (-71.82363 41.25028)  <span style="text-decoration: underline;">1</span>818. 2010-RI-2-4 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span>        2 (-71.82218 41.23396)  <span style="text-decoration: underline;">1</span>818. 2010-RI-2-5 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span>        3 (-71.78729 41.30687)  <span style="text-decoration: underline;">1</span>948. 2010-RI-3-1 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span>        3  (-71.7858 41.28939)  <span style="text-decoration: underline;">1</span>948. 2010-RI-3-2 </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 580 more rows</span></span></span></code></pre>
<p>Notice that our <code>geometry type</code> is now <code>POINT</code>. We can plot these centroids on our previous map:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># geom_sf knows what to do with spatial data</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">coastline</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">transects</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">segs</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># chop to be on a better scale</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">72</span>, <span class="op">-</span><span class="fl">70.8</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">40.8</span>, <span class="fl">41.5</span><span class="op">)</span>, expand<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># make the plot look simpler</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre></div>
<p><img src="dsm-data-formatting_files/figure-html/unnamed-chunk-6-1.png"><!-- --></p>
<p>At present, the <code>dsm</code> package doesn’t know how to talk to <code>sf</code> objects, so as a final step we need to simplify <code>segs</code> to be a regular <code>data.frame</code>, which <code>dsm</code> can interpret. We can extract the coordinates of the centroids using <code>st_coordinates</code> and then append them onto a <code>data.frame</code> version of the object with the geometry dropped, like so:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">segs_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="va">segs</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">segs</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can double check that looks right:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">segs_df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   Transect       Effort Sample.Label         X        Y</span></span>
<span><span class="co">## 1        1 1515.147 [m]  2010-RI-1-1 -71.86887 41.29289</span></span>
<span><span class="co">## 2        1 1515.151 [m]  2010-RI-1-2 -71.86764 41.27930</span></span>
<span><span class="co">## 3        1 1515.155 [m]  2010-RI-1-3 -71.86642 41.26570</span></span>
<span><span class="co">## 4        2 1818.179 [m]  2010-RI-2-1 -71.82799 41.29922</span></span>
<span><span class="co">## 5        2 1818.184 [m]  2010-RI-2-2 -71.82654 41.28290</span></span>
<span><span class="co">## 6        2 1818.190 [m]  2010-RI-2-3 -71.82508 41.26659</span></span></code></pre>
<p>and we are done. See the next section for how to link the segments and the detections.</p>
<p>If we want to include spatial covariate information in the segment table, we could then use (for example) <a href="https://CRAN.R-project.org/package=rerddap" class="external-link"><code>rerrdap</code></a> to obtain remotely-sensed data. For <em>in situ</em> data (i.e., weather conditions recorded while on effort), this can be more complicated and will require the use of <code>summarize</code>, see <a href="https://github.com/r-spatial/sf/issues/321" class="external-link">this thread for more information</a> on how to deal with this situation.</p>
</div>
</div>
<div class="section level3">
<h3 id="linking-observations-and-segments">Linking observations and segments<a class="anchor" aria-label="anchor" href="#linking-observations-and-segments"></a>
</h3>
<p>To link together the data in the detection function and the spatial data giving the effort, we use the observation <code>data.frame</code>. This is really just a cross-reference between those two tables, so each detection lives in one segment.</p>
<p>The observation <code>data.frame</code> must have (at least) the following columns:</p>
<ul>
<li>
<code>object</code> : unique object identifier (corresponding to those identifiers in the detection function)</li>
<li>
<code>Sample.Label</code> : the identifier for the segment that the observation occurred in</li>
<li>
<code>size</code> : the size of each observed group (e.g., 1 if all animals occurred individually)</li>
<li>
<code>distance</code> : distance to observation</li>
</ul>
<p>The observation data should have as many rows as there are in the detection function.</p>
<div class="section level4">
<h4 id="relating-observations-and-segments-in-practice">Relating observations and segments in practice<a class="anchor" aria-label="anchor" href="#relating-observations-and-segments-in-practice"></a>
</h4>
<p>There are a few methods for building the observation table. Here I’ll illustrate one assigning detections to segments based on their distance (i.e., detections are associated with their closest segment centroid). This is appropriate when you don’t see forwards too far, so it’s unlikely that detections will be miss assigned. This is true, for instance, in an aerial survey where observers look out windows located on the sides of the plane but might be inappropriate for a shipboard survey where observers on the flying bridge can see way ahead of the ship.</p>
<p>First loading the detection data for this survey (this would be what we use to fit the detection function, post-processing):</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"data/loons.csv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         Date     Time Bin      Lat      Long Observer object size</span></span>
<span><span class="co">## 1 2011-04-19 18991230   B 40.85296 -71.45511       JV     46    1</span></span>
<span><span class="co">## 2 2011-02-17 18991230   A 40.87022 -71.54842       JV    106    1</span></span>
<span><span class="co">## 3 2011-05-02 18991230   A 40.87595 -71.30304       KW    121    1</span></span>
<span><span class="co">## 4 2011-12-04 18991230   C 40.91753 -71.38273       KW    286    1</span></span>
<span><span class="co">## 5 2011-02-23 18991230   A 40.94153 -71.38517       KW    446    1</span></span>
<span><span class="co">## 6 2011-02-07 18991230   A 40.94225 -71.46438       KW    457    1</span></span></code></pre>
<p>We can see there are columns for latitude and longitude (<code>Lat</code> and <code>Long</code>). We can make this <code>data.frame</code> be an <code>sf</code> object by telling <code>sf</code> that these columns contain spatial coordinates (in <code>sf</code> lingo, “geometry”):</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">obs</span>, coords<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Long"</span>, <span class="st">"Lat"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># set the coordinate system</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">4326</span></span>
<span><span class="va">obs</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 941 features and 6 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -71.86962 ymin: 40.85296 xmax: -70.89175 ymax: 41.46472</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="co">## First 10 features:</span></span>
<span><span class="co">##          Date     Time Bin Observer object size                   geometry</span></span>
<span><span class="co">## 1  2011-04-19 18991230   B       JV     46    1 POINT (-71.45511 40.85296)</span></span>
<span><span class="co">## 2  2011-02-17 18991230   A       JV    106    1 POINT (-71.54842 40.87022)</span></span>
<span><span class="co">## 3  2011-05-02 18991230   A       KW    121    1 POINT (-71.30304 40.87595)</span></span>
<span><span class="co">## 4  2011-12-04 18991230   C       KW    286    1 POINT (-71.38273 40.91753)</span></span>
<span><span class="co">## 5  2011-02-23 18991230   A       KW    446    1 POINT (-71.38517 40.94153)</span></span>
<span><span class="co">## 6  2011-02-07 18991230   A       KW    457    1 POINT (-71.46438 40.94225)</span></span>
<span><span class="co">## 7  2011-04-19 18991230   A       JV    500    2 POINT (-71.59495 40.94761)</span></span>
<span><span class="co">## 8  2011-05-02 18991230   A       KW    506    1   POINT (-71.552 40.94795)</span></span>
<span><span class="co">## 9  2011-02-23 18991230   B       JV    814    1 POINT (-71.51172 40.97912)</span></span>
<span><span class="co">## 10 2011-04-19 18991230   A       KW    911    1 POINT (-71.59762 40.98571)</span></span></code></pre>
<p>We can overlay this on our previous map of transects:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># geom_sf knows what to do with spatial data</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">coastline</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">transects</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">obs</span>, size<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># chop to be on a better scale</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">72</span>, <span class="op">-</span><span class="fl">70.8</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">40.8</span>, <span class="fl">41.5</span><span class="op">)</span>, expand<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># make the plot look simpler</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre></div>
<p><img src="dsm-data-formatting_files/figure-html/unnamed-chunk-7-1.png"><!-- --></p>
<p>Going back to our <code>segs</code> object above, we can use the <code>st_join</code> function, combined with the <code>st_nearest_feature</code> function to control how the tables are linked. Again, we need to project the data to avoid issues.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># project segs</span></span>
<span><span class="va">segs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">segs</span>, <span class="fl">6348</span><span class="op">)</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">obs</span>, <span class="fl">6348</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># do the join</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_join</a></span><span class="op">(</span><span class="va">obs</span>, <span class="va">segs</span>, join<span class="op">=</span><span class="va">st_nearest_feature</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># project back to lat/long</span></span>
<span><span class="va">segs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">segs</span>, <span class="fl">4326</span><span class="op">)</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">obs</span>, <span class="fl">4326</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># how does that look?</span></span>
<span><span class="va">obs</span></span></code></pre></div>
<pre><code><span><span class="co">## Simple feature collection with 941 features and 9 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -71.86962 ymin: 40.85296 xmax: -70.89175 ymax: 41.46472</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="co">## First 10 features:</span></span>
<span><span class="co">##          Date     Time Bin Observer object size Transect       Effort</span></span>
<span><span class="co">## 1  2011-04-19 18991230   B       JV     46    1        8 1969.873 [m]</span></span>
<span><span class="co">## 2  2011-02-17 18991230   A       JV    106    1       26 1894.100 [m]</span></span>
<span><span class="co">## 3  2011-05-02 18991230   A       KW    121    1       12 1988.809 [m]</span></span>
<span><span class="co">## 4  2011-12-04 18991230   C       KW    286    1       10 1979.630 [m]</span></span>
<span><span class="co">## 5  2011-02-23 18991230   A       KW    446    1       10 1979.624 [m]</span></span>
<span><span class="co">## 6  2011-02-07 18991230   A       KW    457    1        8 1969.839 [m]</span></span>
<span><span class="co">## 7  2011-04-19 18991230   A       JV    500    2       24 1923.218 [m]</span></span>
<span><span class="co">## 8  2011-05-02 18991230   A       KW    506    1       26 1894.075 [m]</span></span>
<span><span class="co">## 9  2011-02-23 18991230   B       JV    814    1        7 2000.139 [m]</span></span>
<span><span class="co">## 10 2011-04-19 18991230   A       KW    911    1       24 1923.199 [m]</span></span>
<span><span class="co">##     Sample.Label                   geometry</span></span>
<span><span class="co">## 1   2010-RI-8-29 POINT (-71.45511 40.85296)</span></span>
<span><span class="co">## 2  2010-RI-26-16 POINT (-71.54842 40.87022)</span></span>
<span><span class="co">## 3  2010-RI-12-31 POINT (-71.30304 40.87595)</span></span>
<span><span class="co">## 4  2010-RI-10-27 POINT (-71.38273 40.91753)</span></span>
<span><span class="co">## 5  2010-RI-10-26 POINT (-71.38517 40.94153)</span></span>
<span><span class="co">## 6   2010-RI-8-24 POINT (-71.46438 40.94225)</span></span>
<span><span class="co">## 7  2010-RI-24-12 POINT (-71.59495 40.94761)</span></span>
<span><span class="co">## 8  2010-RI-26-12   POINT (-71.552 40.94795)</span></span>
<span><span class="co">## 9   2010-RI-7-22 POINT (-71.51172 40.97912)</span></span>
<span><span class="co">## 10  2010-RI-24-9 POINT (-71.59762 40.98571)</span></span></code></pre>
<p>Now <code>obs</code> has acquired additional columns from <code>segs</code>, including the <code>Sample.Label</code> (which we want) and <code>Effort</code> (which we don’t). To check this worked okay, we can plot the <code>obs</code> and <code>segs_lines</code> (the line version of the segments which we saved earlier) with colour coding for the <code>Sample.Label</code>. I randomized the colour order so it would be easier to tell if observations were misallocated.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># make a random colour palette to avoid similar colours being near each other</span></span>
<span><span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">rainbow</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">segs</span><span class="op">)</span>, s<span class="op">=</span><span class="fl">.6</span>, v<span class="op">=</span><span class="fl">.9</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">segs</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">segs</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># geom_sf knows what to do with spatial data</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">coastline</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">segs_lines</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour<span class="op">=</span><span class="va">Sample.Label</span><span class="op">)</span>, pch<span class="op">=</span><span class="fl">21</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">obs</span>, size<span class="op">=</span><span class="fl">0.5</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour<span class="op">=</span><span class="va">Sample.Label</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># chop to be on a better scale</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">72</span>, <span class="op">-</span><span class="fl">70.8</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">40.8</span>, <span class="fl">41.5</span><span class="op">)</span>, expand<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="va">pal</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># make the plot look simpler</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre></div>
<p><img src="dsm-data-formatting_files/figure-html/plot-check-1.png"><!-- --></p>
<p>As with <code>segs</code> we can remove unnecessary columns and geometry to get the required columns only:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get rid of "spatialness"</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span></span>
<span><span class="co"># select the columns we need</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="va">obs</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"object"</span>, <span class="st">"Sample.Label"</span>, <span class="st">"size"</span>, <span class="st">"Bin"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   object  Sample.Label size Bin</span></span>
<span><span class="co">## 1     46  2010-RI-8-29    1   B</span></span>
<span><span class="co">## 2    106 2010-RI-26-16    1   A</span></span>
<span><span class="co">## 3    121 2010-RI-12-31    1   A</span></span>
<span><span class="co">## 4    286 2010-RI-10-27    1   C</span></span>
<span><span class="co">## 5    446 2010-RI-10-26    1   A</span></span>
<span><span class="co">## 6    457  2010-RI-8-24    1   A</span></span></code></pre>
<p>(Note here since we have binned data, we just keep the <code>Bin</code> column and need to process this further later.)</p>
<p>A different way to approach this would be if there were timestamps on waypoints from the GPS, which could be related to the segments. One could then look at whether an observation was made between the start and end times of a segment.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="more-information">More information<a class="anchor" aria-label="anchor" href="#more-information"></a>
</h2>
<p>We have provided some information about segmenting on <a href="https://osf.io/wgc4f/wiki/Splitting%20transects%20into%20segments/" class="external-link">this wiki page</a>, as part of the US Navy-funded project <a href="https://synergy.st-andrews.ac.uk/denmod/" class="external-link">DenMod</a>.</p>
<p>This information is summarized at <code><a href="../../reference/dsm-data.html">?"dsm-data"</a></code> in the <code>dsm</code> package. It may also be useful to look at the data in the example dataset <code>mexdolphins</code> which can be loaded with <code>data(mexdolphins)</code>. The vignette for an analysis of those data <a href="http://distancedevelopment.github.io/dsm/articles/lines_gomex/mexico-analysis.html" class="external-link">is available here</a>.</p>
<p>It is hard to give very general information on how to segment lines, as to some extent it depends on how the data were originally formatted (going all the way back to the make and model of the GPS unit used). More information on dealing with spatial data in R using the <code>sf</code> package is available at <a href="https://r-spatial.github.io/sf/" class="external-link">the R spatial website</a> (see the “Articles” drop down in the header).</p>
<p>Another source of help is the <a href="https://groups.google.com/forum/#!topic/distance-sampling/" class="external-link">distance sampling mailing list</a>. Be sure to search the archives prior to posting as there have been several threads on segmenting previously that might be helpful.</p>
</div>
<div class="section level2">
<h2 id="acknowledgements">Acknowledgements<a class="anchor" aria-label="anchor" href="#acknowledgements"></a>
</h2>
<p>Thanks to Phil Bouchet for providing helpful comments to an early version of this document and to Iúri Correia for finding an important bug.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0" line-spacing="2">
<div id="ref-winiarski_integrating_2014" class="csl-entry">
Winiarski, K. J., Burt, M. L., Rexstad, E., Miller, D. L., Trocki, C. L., Paton, P. W. C., &amp; McWilliams, S. R. (2014). Integrating aerial and ship surveys of marine birds into a combined density surface model: <span>A</span> case study of wintering <span>Common</span> <span>Loons</span>. <em>The Condor</em>, <em>116</em>(2), 149–161. <a href="https://doi.org/10.1650/CONDOR-13-085.1" class="external-link">https://doi.org/10.1650/CONDOR-13-085.1</a>
</div>
<div id="ref-winiarski_spatial_2014" class="csl-entry">
Winiarski, K. J., Miller, D. L., Paton, P. W. C., &amp; McWilliams, S. R. (2014). A spatial conservation prioritization approach for protecting marine birds given proposed offshore wind energy development. <em>Biological Conservation</em>, <em>169</em>, 79–88. <a href="https://doi.org/10.1016/j.biocon.2013.11.004" class="external-link">https://doi.org/10.1016/j.biocon.2013.11.004</a>
</div>
<div id="ref-winiarski_spatially_2013" class="csl-entry">
Winiarski, K., Miller, D., Paton, P., &amp; McWilliams, S. (2013). Spatially explicit model of wintering common loons: Conservation implications. <em>Marine Ecology Progress Series</em>, <em>492</em>, 273–283. <a href="https://doi.org/10.3354/meps10492" class="external-link">https://doi.org/10.3354/meps10492</a>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>We improve our site and software support by using Microsoft Clarity to see <br> how you use our website. By using our site, you agree that we and Microsoft <br> can collect and use this data. Clarity is GDPR compliant.</p>
</div>

<div class="pkgdown-footer-right">
  <p>If you wish to donate to development and maintenance, please <a href="mailto:distance@st-andrews.ac.uk">email us</a>.</p>
</div>

    </footer>
</div>





  </body>
</html>
